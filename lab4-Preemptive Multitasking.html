
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>lab4: Preemptive Multitasking · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="lab5-File system, Spawn and Shell.html" />
    
    
    <link rel="prev" href="Lab3-User Environments.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="preparation.html">
            
                <a href="preparation.html">
            
                    
                    准备工作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="lab1-Booting a PC.html">
            
                <a href="lab1-Booting a PC.html">
            
                    
                    Lab1: Booting a PC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="lab2-Memory Management.html">
            
                <a href="lab2-Memory Management.html">
            
                    
                    lab2: Memory Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="Lab3-User Environments.html">
            
                <a href="Lab3-User Environments.html">
            
                    
                    Lab3: User Environments
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6" data-path="lab4-Preemptive Multitasking.html">
            
                <a href="lab4-Preemptive Multitasking.html">
            
                    
                    lab4: Preemptive Multitasking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="lab5-File system, Spawn and Shell.html">
            
                <a href="lab5-File system, Spawn and Shell.html">
            
                    
                    lab5: File system, Spawn and Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="lab6-Network Driver.html">
            
                <a href="lab6-Network Driver.html">
            
                    
                    lab6: Network Driver
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >lab4: Preemptive Multitasking</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="lab-4-preemptive-multitasking">Lab 4: Preemptive Multitasking</h2>
<p>&#x8FD9;&#x4E2A;&#x5B9E;&#x9A8C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x62A2;&#x5360;&#x5F0F;(preemptive)&#x7684;&#x591A;&#x6838;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>&#x5B9E;&#x9A8C;&#x6574;&#x4F53;&#x7684;&#x601D;&#x7EF4;&#x5BFC;&#x56FE;&#xFF1A;</p>
<p><img src="lab4-Preemptive Multitasking/arch.png" alt=""></p>
<h3 id="part-a-multiprocessor-support-and-cooperative-multitasking">Part A: Multiprocessor Support and Cooperative Multitasking</h3>
<p>part A&#x6211;&#x4EEC;&#x5C06;&#x62D3;&#x5C55;&#x539F;&#x6765;&#x7684;JOS&#x7CFB;&#x7EDF;&#xFF0C;&#x4F7F;&#x4E4B;&#x53D8;&#x6210;&#x4E00;&#x4E2A;&#x591A;&#x6838;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>&#x4E4B;&#x540E;&#x5B9E;&#x73B0;&#x4E00;&#x4E9B;system call&#xFF0C;&#x4F7F;&#x5F97;&#x80FD;&#x591F;&#x5728;&#x7528;&#x6237;&#x6001;&#x5EFA;&#x7ACB;&#x4E00;&#x4E9B;&#x65B0;&#x7684;environments&#x3002;</p>
<p>&#x7136;&#x540E;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;<code>cooperative round-robin</code>&#x8C03;&#x5EA6;&#x7B97;&#x6CD5;&#xFF0C;&#x5F53;&#x67D0;&#x4E2A;environment&#x4E3B;&#x52A8;&#x9000;&#x51FA;CPU&#x7684;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;(&#x540E;&#x9762;&#x9ED8;&#x8BA4;&#x8FDB;&#x7A0B; == environment)&#x63A5;&#x7740;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x62A2;&#x5360;&#x5F0F;&#x7684;&#x8C03;&#x5EA6;&#x7B97;&#x6CD5;&#xFF0C;&#x5F53;&#x67D0;&#x4E2A;&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x4E0D;&#x4E00;&#x5B9A;&#x6267;&#x884C;&#x5B8C;&#x4E86;&#xFF09;&#xFF0C;&#x4F7F;&#x5F97;&#x5185;&#x6838;&#x80FD;&#x591F;&#x91CD;&#x65B0;&#x4F7F;&#x7528;CPU&#x3002;</p>
<h4 id="multiprocessor-support">Multiprocessor Support</h4>
<p>&#x5728;&#x542F;&#x52A8;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;CPU&#x5206;&#x6210;&#x4E24;&#x7C7B;&#xFF1A;</p>
<ul>
<li>the bootstrap processor (BSP)&#xFF1A;&#x4E3B;&#x8981;&#x8D1F;&#x8D23;&#x5185;&#x6838;&#x7684;&#x542F;&#x52A8;</li>
<li>the application processors(APs)&#xFF1A;&#x662F;&#x88AB;BSP&#x542F;&#x52A8;&#x7684;&#x3002;</li>
</ul>
<p>&#x81F3;&#x4E8E;&#x54EA;&#x4E00;&#x4E2A;CPU&#x6838;&#x662F;BSP&#xFF0C;&#x5219;&#x662F;&#x88AB;&#x786C;&#x4EF6;&#x548C;BIOS&#x6240;&#x786E;&#x5B9A;&#x7684;&#x3002;</p>
<p>&#x5728;SMP(symmetric multiprocessing)&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;CPU&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;local APIC(advanced programmable interrupt controller)&#x3002;&#x8FD9;&#x4E9B;LAPIC&#x4E3B;&#x8981;&#x8D1F;&#x8D23;&#x4F20;&#x9012;&#x4E00;&#x4E9B;&#x4E2D;&#x65AD;&#x4FE1;&#x53F7;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;&#x5355;&#x5143;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;unique identifier&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x4F7F;&#x7528;LAPIC&#x5355;&#x5143;&#x7684;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#x3002;</p>
<ul>
<li>&#x8BFB;&#x53D6;LAPIC id&#xFF0C;&#x4ECE;&#x800C;&#x77E5;&#x9053;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x6B64;&#x523B;&#x4EE3;&#x7801;&#x662F;&#x8DD1;&#x5728;&#x54EA;&#x4E00;&#x4E2A;CPU&#x4E2D;&#x7684;&#x3002;</li>
</ul>
<pre><code class="lang-c"><span class="hljs-keyword">uint8_t</span> cpu_id;                 <span class="hljs-comment">// Local APIC ID; index into cpus[] below</span>
</code></pre>
<ul>
<li>BSP&#x53D1;&#x9001;<code>STARTUP</code>interprocessor interrrupt(IPI)&#x7ED9;APs&#xFF0C;&#x4F7F;&#x5F97;&#x80FD;&#x591F;&#x542F;&#x52A8;&#x5176;&#x4ED6;&#x7684;CPU&#x3002;&#xFF08;&#x89C1; <code>lapic_startap()</code>&#xFF09;</li>
<li>&#x5728;part C&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x5185;&#x7F6E;&#x7684;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#xFF0C;&#x4F7F;&#x5F97;&#x80FD;&#x591F;&#x652F;&#x6301;&#x62A2;&#x5360;&#x5F0F;&#x591A;&#x4EFB;&#x52A1;&#x3002;</li>
</ul>
<p>&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x901A;&#x8FC7;memory-mapped I/O(MMIO)&#x6765;&#x83B7;&#x53D6;&#x5B83;&#x7684;LAPIC&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x662F;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x8BFB;&#x5199;&#x5185;&#x5B58;&#x6765;&#x64CD;&#x63A7;&#x786C;&#x4EF6;&#xFF08;&#x867D;&#x7136;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x662F;&#x64CD;&#x4F5C;&#x5185;&#x5B58;&#xFF0C;&#x4F46;&#x5B9E;&#x9645;&#x4E0A;&#x8FD8;&#x662F;&#x548C;&#x786C;&#x4EF6;&#x4E2D;&#x7684;&#x5B58;&#x50A8;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF09;&#x3002;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x5728;&#x6700;&#x5F00;&#x59CB;&#x7684;1MB&#x5185;&#x5B58;&#x4E2D;0xA0000&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x5F00;&#x59CB;&#x5B58;&#x653E;&#x7684;&#x662F;VGA display buffer&#x3002;</p>
<h4 id="exercise-1">exercise 1</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>kern/pmap.c</code>&#x4E2D;&#x7684;mmio_map_region&#x3002;</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x8BFB;&#x53D6;&#x5230;CPU&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x540E;&#xFF0C;&#x91CC;&#x9762;&#x6709;LAPIC&#x5355;&#x5143;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;(lapicaddr)&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x5C06;&#x865A;&#x62DF;&#x5730;&#x5740;<code>MMIOBASE</code>&#x6620;&#x5C04;&#x5230;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> *
<span class="hljs-title">mmio_map_region</span><span class="hljs-params">(physaddr_t pa, size_t size)</span>
</span>{
    <span class="hljs-comment">// Where to start the next region.  Initially, this is the</span>
    <span class="hljs-comment">// beginning of the MMIO region.  Because this is static, its</span>
    <span class="hljs-comment">// value will be preserved between calls to mmio_map_region</span>
    <span class="hljs-comment">// (just like nextfree in boot_alloc).</span>
    <span class="hljs-comment">// &#x8FD9;&#x4E2A;static&#x5F88;&#x5173;&#x952E;&#x554A;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x7528;&#x4FDD;&#x5B58;&#x4E3A;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x4E86;&#x3002;</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">uintptr_t</span> base = MMIOBASE;


    <span class="hljs-comment">// write through: &#x540C;&#x65F6;&#x66F4;&#x65B0;cache&#x548C;&#x540E;&#x7AEF;&#x7684;&#x5B58;&#x50A8;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment">// write back: &#x4EC5;&#x4EC5;&#x66F4;&#x65B0;cache&#x4E2D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5FC5;&#x8981;&#x65F6;&#x624D;&#x5F80;&#x540E;&#x7AEF;&#x7684;&#x8BBE;&#x5907;&#x5199;&#x56DE;&#x6570;&#x636E;</span>

    <span class="hljs-comment">// Your code here:</span>
    <span class="hljs-keyword">if</span>(base + ROUNDUP(size, PGSIZE) &gt; MMIOLIM)
        panic(<span class="hljs-string">&quot;mmio_map_region: mmio overflow.&quot;</span>);
    boot_map_region(kern_pgdir, base, ROUNDUP(size, PGSIZE), pa, PTE_W|PTE_PCD|PTE_PWT);
    <span class="hljs-keyword">uintptr_t</span> temp = base;
    base += ROUNDUP(size, PGSIZE);
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *)temp;
    panic(<span class="hljs-string">&quot;mmio_map_region not implemented&quot;</span>);
}
</code></pre>
<p>mmio&#x662F;&#x4E00;&#x5757;&#x5F88;&#x7279;&#x6B8A;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x80FD;&#x591F;&#x50CF;&#x8BBF;&#x95EE;&#x5185;&#x5B58;&#x4E00;&#x6837;&#xFF0C;&#x53BB;&#x8BBF;&#x95EE;&#x786C;&#x4EF6;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x4F46;&#x662F;&#x53C8;&#x548C;&#x4E00;&#x822C;&#x7684;&#x5185;&#x5B58;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x4E00;&#x822C;&#x5185;&#x5B58;&#x90FD;&#x5E26;&#x6709;&#x7F13;&#x5B58;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5C06;&#x5185;&#x5B58;&#x7684;&#x5185;&#x5BB9;&#x7F13;&#x5B58;&#x5230;CPU&#x7684;cache&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x8BBE;&#x5907;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x591A;&#x53D8;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;&#x5185;&#x5B58;&#x7684;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#x5173;&#x95ED;&#x3002;&#x5E78;&#x8FD0;&#x7684;&#x662F;&#xFF0C;&#x5185;&#x5B58;&#x7684;&#x6743;&#x9650;&#x4F4D;&#x63D0;&#x4F9B;&#x8FD9;&#x6837;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x9700;&#x8981;&#x5C06;&#x76F8;&#x5E94;&#x7684;&#x6743;&#x9650;&#x4E3A;&#x8BBE;&#x7F6E;&#x4E3A;<code>PTE_PCD</code>&#x548C;<code>PTE_PWT</code>&#x5373;&#x53EF;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;cache disable&#x548C;write through&#x3002;</p>
<h4 id="application-processor-bootstrap">Application Processor Bootstrap</h4>
<p>&#x5728;&#x542F;&#x52A8;APs&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BFB;&#x53D6;&#x4ECE;BIOS&#x533A;&#x57DF;&#x8BFB;&#x53D6;&#x4E00;&#x4E9B;&#x4FE1;&#x606F;&#xFF0C;&#x5982;CPU&#x7684;&#x6570;&#x91CF;&#xFF0C;APIC ID&#x548C;MMIO&#x7269;&#x7406;&#x5730;&#x5740;&#x3002;</p>
<p>&#x9A71;&#x52A8;APs&#x7684;&#x51FD;&#x6570;&#x5728;<code>boot_aps</code>&#x4E2D;&#x3002;APs&#x7684;&#x542F;&#x52A8;&#x5728;&#x5B9E;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x548C;boot loader&#x7684;&#x542F;&#x52A8;&#x65B9;&#x5F0F;&#x5F88;&#x50CF;&#x3002;&#x56E0;&#x6B64;<code>boot_aps()</code>&#x5C06;&#x8981;&#x6267;&#x884C;&#x7684;&#x4EE3;&#x7801;&#x590D;&#x5236;&#x5230;&#x5B9E;&#x6A21;&#x5F0F;&#x80FD;&#x591F;&#x5BFB;&#x5740;&#x5230;&#x7684;&#x5730;&#x65B9;&#xFF08;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x653E;&#x5728;&#x4E86;<code>0x7000</code> (<code>MPENTRY_PADDR</code>)&#xFF09;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x4EFB;&#x4F55;&#x653E;&#x5728;640KB&#x4EE5;&#x4E0B;&#x7684;&#x5185;&#x5B58;&#x90FD;&#x662F;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#x7684;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">// Write entry code to unused memory at MPENTRY_PADDR</span>
code = KADDR(MPENTRY_PADDR);
memmove(code, mpentry_start, mpentry_end - mpentry_start);
</code></pre>
<p>&#x653E;&#x7F6E;&#x597D;&#x8981;&#x6267;&#x884C;&#x7684;&#x4EE3;&#x7801;&#x4E4B;&#x540E;&#xFF0C;boot_aps&#x4F9D;&#x6B21;&#x6FC0;&#x6D3B;APs&#xFF0C;&#x9996;&#x5148;&#x53D1;&#x9001;&#x4E00;&#x4E2A;<code>STARTUP</code>&#x7684;IPI&#x4E2D;&#x65AD;&#xFF0C;&#x7136;&#x540E;&#x8BBE;&#x7F6E;CS:IP&#x5BC4;&#x5B58;&#x5668;&#x3002;</p>
<p>&#x4E4B;&#x540E;APs&#x7C7B;&#x4F3C;&#x4E8E;boot loader&#x90E8;&#x5206;&#x6267;&#x884C;&#x521D;&#x59CB;&#x5316;&#x4EE3;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x8FD0;&#x884C;mp_main()&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E9B;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x5982;GDT&#xFF0C;TSS&#x7B49;&#x7B49;&#x3002;BSP&#x4F1A;&#x7B49;&#x5F85;APs&#x7684; <code>CPU_STARTED</code>&#x4FE1;&#x53F7;&#xFF0C;&#x6536;&#x5230;&#x4E86;&#x624D;&#x4F1A;&#x6FC0;&#x6D3B;&#x5176;&#x4ED6;&#x7684;APs&#x3002;</p>
<h4 id="exercise-2">exercise 2</h4>
<blockquote>
<p>&#x9605;&#x8BFB;&#x76F8;&#x5173;&#x90E8;&#x5206;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4FEE;&#x6539;<code>kern/pmap.c</code>&#x4E2D;&#x7684;page_init&#x51FD;&#x6570;&#xFF0C;&#x5C06;<code>MPENTRY_PADDR</code>&#x7684;&#x9875;&#x4ECE;page_free_list&#x4E2D;&#x79FB;&#x9664;&#x3002;</p>
</blockquote>
<pre><code class="lang-c"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; npages_basemem; i++) {
        <span class="hljs-keyword">if</span>(i == MPENTRY_PADDR/PGSIZE){
            pages[i].pp_ref = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">continue</span>;
        }
        pages[i].pp_ref = <span class="hljs-number">0</span>;
        pages[i].pp_link = page_free_list;
        page_free_list = &amp;pages[i];
}
</code></pre>
<p>Q1: &#x5BF9;&#x6BD4;<code>kern/mpentry.S</code>&#x548C;<code>boot/boot.S</code>&#xFF0C;&#x8BB0;&#x4F4F;<code>kern/mpentry.S</code>&#x59CB;&#x7EC8;&#x662F;&#x8FD0;&#x884C;&#x5728;KERNBASE&#x5730;&#x5740;&#x4E4B;&#x4E0A;&#x7684;&#x3002;&#x90A3;&#x4E48;&#x5728;<code>kern/mpentry.S</code>&#x4E2D;&#x7684;<code>MPBOOTPHYS</code>&#x5B8F;&#x5B9A;&#x4E49;&#x7684;&#x76EE;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;<code>kern/mpentry.S</code>&#x662F;&#x5FC5;&#x8981;&#x7684;&#xFF0C;&#x800C;&#x5728;boot loader&#x4E2D;&#x4E0D;&#x9700;&#x8981;&#xFF1F;&#x5982;&#x679C;&#x53BB;&#x6389;&#x6709;&#x4EC0;&#x4E48;&#x9519;&#x8BEF;&#xFF1F;</p>
<p>A&#xFF1A;boot.S&#x5728;&#x5B9E;&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#xFF0C;&#x800C;&#x91CD;&#x65B0;&#x8FDB;&#x5165;&#x65F6;&#xFF0C;<code>mpentry.S</code>&#x662F;&#x5728;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#x4E0B;&#x8FDB;&#x884C;&#x7684;&#x3002;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x91CD;&#x65B0;&#x5C06;&#x5176;&#x8F6C;&#x5316;&#x4E3A;&#x5B9E;&#x9645;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5730;&#x5740;&#x3002;</p>
<h4 id="per-cpu-state-and-initialization">Per-CPU State and Initialization</h4>
<p>&#x5F53;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x591A;&#x6838;&#x7CFB;&#x7EDF;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x533A;&#x5206;&#x79C1;&#x6709;&#x7684;&#x72B6;&#x6001;&#x8FD8;&#x662F;&#x5171;&#x4EAB;&#x7684;&#x72B6;&#x6001;&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6BCF;&#x4E00;&#x4E2A;CPU&#x4E0B;&#x9762;&#x7684;&#x4E00;&#x4E9B;&#x72B6;&#x6001;&#xFF1A;</p>
<ul>
<li>per-CPU kernel stack</li>
</ul>
<p>&#x6BCF;&#x4E00;&#x4E2A;CPU&#x7684;&#x6808;&#x5185;&#x5BB9;&#x4FDD;&#x5B58;&#x5728;<code>percpu_kstacks[NCPU][KSTKSIZE]</code>&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;&#x865A;&#x62DF;&#x5730;&#x5740;&#x4ECE;<code>KSTACKTOP</code>&#x5F00;&#x59CB;&#x5411;&#x4E0B;&#x4F9D;&#x6B21;&#x7684;&#x8FDB;&#x884C;&#x6620;&#x5C04;&#x3002;</p>
<p>&#x5E76;&#x4E14;&#x4E0D;&#x540C;CPU&#x6808;&#x4E2D;&#x95F4;&#x662F;&#x6709;&#x4E00;&#x5757;&#x9694;&#x79BB;&#x533A;&#x7684;&#x3002;</p>
<ul>
<li>per-CPU TSS &#x548C; TSS descriptor</li>
</ul>
<p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x63D0;&#x5230;TSS&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x662F;&#x4FDD;&#x5B58;&#x5904;&#x7406;&#x5668;&#x65E7;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x65B9;&#x4FBF;&#x7528;&#x6237;&#x6001;&#x8DF3;&#x8F6C;&#x56DE;&#x5185;&#x6838;&#x6001;&#x3002;&#x73B0;&#x5728;&#x591A;&#x6838;&#x7CFB;&#x7EDF;&#x4E2D;&#x662F;&#x4FDD;&#x5B58;CPU&#x7684;&#x6808;&#x548C;&#x82E5;&#x5E72;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5177;&#x4F53;&#x4F7F;&#x7528;<code>cpus[i].cpu_ts</code>&#x53D8;&#x91CF;&#x3002;TSS descriptor&#x4FDD;&#x5B58;&#x5728;&#x4E2A;GDT&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;<code>gdt[(GD_TSS0 &gt;&gt; 3) + i]</code>&#x8FDB;&#x884C;&#x7D22;&#x5F15;&#x3002;</p>
<ul>
<li>per-CPU&#x76EE;&#x524D;&#x6267;&#x884C;&#x7684;&#x8FDB;&#x7A0B;</li>
</ul>
<p>&#x901A;&#x8FC7;<code>cpus[cpunum()].cpu_env</code>&#x8FDB;&#x884C;&#x7D22;&#x5F15;&#x3002;</p>
<ul>
<li>per-CPU system registers</li>
</ul>
<p>&#x6240;&#x6709;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5305;&#x62EC;&#x7CFB;&#x7EDF;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5BF9;CPU&#x90FD;&#x662F;&#x9690;&#x79D8;&#x7684;&#xFF08;&#x611F;&#x89C9;&#x8FD9;&#x91CC;&#x8BB2;&#x7684;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x5E94;&#x8BE5;&#x6BCF;&#x4E00;&#x4E2A;CPU&#x90FD;&#x6709;&#x5C5E;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x76F8;&#x4E92;&#x72EC;&#x7ACB;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF09;&#x3002;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E00;&#x4E9B;&#x51FD;&#x6570;<code>lcr3()</code>, <code>ltr()</code>, <code>lgdt()</code>, <code>lidt()</code>&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x3002;</p>
<h4 id="exercise-3">exercise 3</h4>
<blockquote>
<p>&#x4FEE;&#x6539;&#x5728;<code>kern/pmap.c</code>&#x4E2D;&#x7684;mem_init_mp()&#xFF0C;&#x4ECE;&#x800C;&#x5C06;&#x865A;&#x62DF;&#x5730;&#x5740;&#x4E0E;&#x7269;&#x7406;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x6620;&#x5C04;&#x3002;</p>
</blockquote>
<pre><code class="lang-c">mem_init_mp(<span class="hljs-keyword">void</span>)
{
    <span class="hljs-comment">// Map per-CPU stacks starting at KSTACKTOP, for up to &apos;NCPU&apos; CPUs.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// For CPU i, use the physical memory that &apos;percpu_kstacks[i]&apos; refers</span>
    <span class="hljs-comment">// to as its kernel stack. CPU i&apos;s kernel stack grows down from virtual</span>
    <span class="hljs-comment">// address kstacktop_i = KSTACKTOP - i * (KSTKSIZE + KSTKGAP), and is</span>
    <span class="hljs-comment">// divided into two pieces, just like the single stack you set up in</span>
    <span class="hljs-comment">// mem_init:</span>
    <span class="hljs-comment">//     * [kstacktop_i - KSTKSIZE, kstacktop_i)</span>
    <span class="hljs-comment">//          -- backed by physical memory</span>
    <span class="hljs-comment">//     * [kstacktop_i - (KSTKSIZE + KSTKGAP), kstacktop_i - KSTKSIZE)</span>
    <span class="hljs-comment">//          -- not backed; so if the kernel overflows its stack,</span>
    <span class="hljs-comment">//             it will fault rather than overwrite another CPU&apos;s stack.</span>
    <span class="hljs-comment">//             Known as a &quot;guard page&quot;.</span>
    <span class="hljs-comment">//     Permissions: kernel RW, user NONE</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// LAB 4: Your code here:</span>
    <span class="hljs-keyword">uint32_t</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">uintptr_t</span> start = KSTACKTOP-KSTKSIZE;
    <span class="hljs-keyword">for</span>(; i&lt;NCPU; i++){
        boot_map_region(kern_pgdir, start, KSTKSIZE, PADDR(percpu_kstacks[i]), PTE_W);
        start -= (KSTKSIZE+KSTKGAP);
    }

}
</code></pre>
<p><code>KSTKGAP</code>&#x8D77;&#x5230;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x9694;&#x79BB;&#x5404;CPU&#x7684;&#x6808;&#x7A7A;&#x95F4;&#xFF0C;&#x9632;&#x6B62;&#x76F8;&#x4E92;&#x5E72;&#x6270;&#x3002;</p>
<h4 id="exercise-4">exercise 4</h4>
<blockquote>
<p>&#x5728;lab3 &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5168;&#x5C40;&#x7684;ts&#x6765;&#x4FDD;&#x5B58;&#x65E7;&#x7684;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x7684;&#x72B6;&#x6001;&#x3002;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;CPU&#x90FD;&#x4FDD;&#x5B58;&#x4E00;&#x4E2A;ts&#x3002;</p>
</blockquote>
<pre><code class="lang-c"><span class="hljs-comment">// Initialize and load the per-CPU TSS and IDT</span>
<span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">trap_init_percpu</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">// Setup a TSS so that we get the right stack</span>
    <span class="hljs-comment">// when we trap to the kernel.</span>
    <span class="hljs-comment">//ts.ts_esp0 = KSTACKTOP;</span>
    <span class="hljs-comment">//ts.ts_ss0 = GD_KD;</span>
    <span class="hljs-comment">//ts.ts_iomb = sizeof(struct Taskstate);</span>
    <span class="hljs-keyword">struct</span> Taskstate *thists = &amp;thiscpu-&gt;cpu_ts;
    thists-&gt;ts_esp0 = KSTACKTOP - thiscpu-&gt;cpu_id * (KSTKSIZE + KSTKGAP);
    thists-&gt;ts_ss0 = GD_KD;
    thists-&gt;ts_iomb = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate);

    <span class="hljs-comment">// Initialize the TSS slot of the gdt.</span>
    gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + thiscpu-&gt;cpu_id] = SEG16(STS_T32A, (<span class="hljs-keyword">uint32_t</span>) (thists),
                    <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
    gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + thiscpu-&gt;cpu_id].sd_s = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// Load the TSS selector (like other segment selectors, the</span>
    <span class="hljs-comment">// bottom three bits are special; we leave them 0)</span>
    ltr(GD_TSS0+ (thiscpu-&gt;cpu_id &lt;&lt; <span class="hljs-number">3</span>));

    <span class="hljs-comment">// Load the IDT</span>
    lidt(&amp;idt_pd);
}
</code></pre>
<h4 id="locking">Locking</h4>
<p>&#x5728;&#x8BA9;APs&#x8FDB;&#x4E00;&#x6B65;&#x6267;&#x884C;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x89E3;&#x51B3;&#x5185;&#x6838;&#x7ADE;&#x4E89;&#x7684;&#x95EE;&#x9898;&#x9632;&#x6B62;&#x591A;&#x4E2A;CPU&#x540C;&#x65F6;&#x8FD0;&#x884C;&#x5185;&#x6838;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x76EE;&#x524D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x5927;&#x9501;&#xFF0C;&#x4F7F;&#x5F97;&#x6709;&#x4E00;&#x4E2A;CPU&#x8FDB;&#x5165;&#x5185;&#x6838;&#x65F6;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9501;&#x4F4F;&#x5185;&#x6838;&#xFF0C;&#x4EC5;&#x5141;&#x8BB8;&#x4E00;&#x4E2A;CPU&#x8FD0;&#x884C;&#x3002;&#x5F53;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6001;&#x65F6;&#xFF0C;&#x5C31;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#x3002;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x5927;&#x9501;&#x8BBE;&#x8BA1;&#xFF0C;&#x4F7F;&#x5F97;&#x7528;&#x6237;&#x6001;&#x7684;&#x7A0B;&#x5E8F;&#x80FD;&#x591F;&#x591A;CPU&#x7684;&#x8FD0;&#x884C;&#xFF0C;&#x4EC5;&#x80FD;&#x6709;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;&#x5185;&#x6838;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5904;&#x7406;&#x5668;&#x8FDB;&#x7A0B;&#x90FD;&#x5F97;&#x7B49;&#x5F85;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;&#x4E0B;&#x9762;&#x7684;&#x56DB;&#x4E2A;&#x5730;&#x65B9;&#x8FD0;&#x7528;&#x5185;&#x6838;&#x9501;&#xFF1A;</p>
<ul>
<li><code>i386_init()</code>&#x4E2D;&#x5524;&#x8D77;&#x5176;&#x4ED6;APs&#x524D;&#x9700;&#x8981;&#x9501;&#x5B9A;&#x5185;&#x6838;</li>
<li><code>mp_main()</code>&#x4E2D;&#x5C1D;&#x8BD5;&#x7740;&#x7D22;&#x53D6;&#x5185;&#x6838;&#x9501;&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x8FDB;&#x884C;&#x8FDB;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x3002;</li>
<li><code>trap()</code>&#x4E2D;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;&#xFF0C;&#x5C1D;&#x8BD5;&#x7740;&#x53BB;&#x83B7;&#x53D6;&#x9501;&#x3002;</li>
<li><code>env_run()</code>&#x5728;<code>env_pop_tf()</code>&#x524D;&#x91CA;&#x653E;&#x9501;&#x3002;</li>
</ul>
<p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4EC5;&#x6709;&#x4E00;&#x5904;&#x662F;&#x9501;&#x7684;&#x91CA;&#x653E;&#x7684;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x4ECE;&#x5185;&#x6838;&#x6001;&#x8FDB;&#x5165;&#x5230;&#x7528;&#x6237;&#x6001;&#x7684;&#x524D;&#x5915;&#x3002;</p>
<h4 id="exercise-5">exercise 5</h4>
<blockquote>
<p>&#x5728;&#x5408;&#x9002;&#x7684;&#x4F4D;&#x7F6E;&#x8FD0;&#x884C;<code>lock_kernel</code>&#x548C;<code>unlock_kernel</code>&#x3002;</p>
</blockquote>
<p>&#x76EE;&#x524D;&#x8FD8;&#x65E0;&#x6CD5;&#x6D4B;&#x8BD5;&#x9501;&#x7684;&#x6B63;&#x786E;&#x6027;&#x3002;</p>
<p>&#x51E0;&#x5904;&#x52A0;&#x9501;&#xFF1A;</p>
<ol>
<li>&#x4E00;&#x4E2A;CPU&#x5C1D;&#x8BD5;&#x7740;&#x542F;&#x52A8;&#x5176;&#x4ED6;&#x7684;CPU&#x7684;&#x65F6;&#x5019;</li>
</ol>
<pre><code class="lang-c"><span class="hljs-comment">// Lab 4 multiprocessor initialization functions</span>
    mp_init();
    lapic_init();

    <span class="hljs-comment">// Lab 4 multitasking initialization functions</span>
    pic_init();

    <span class="hljs-comment">// Acquire the big kernel lock before waking up APs</span>
    <span class="hljs-comment">// Your code here:</span>
    lock_kernel();
    <span class="hljs-comment">// Starting non-boot CPUs, mpentry.S &#x5165;&#x70B9;</span>
    boot_aps();
</code></pre>
<ol>
<li>&#x4ECE;&#x7528;&#x6237;&#x6001;&#x9677;&#x5165;&#x5230;&#x5185;&#x6838;&#x6001;&#xFF1A;</li>
</ol>
<pre><code class="lang-c"><span class="hljs-keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">3</span>) {
        <span class="hljs-comment">// Trapped from user mode.</span>
        <span class="hljs-comment">// Acquire the big kernel lock before doing any</span>
        <span class="hljs-comment">// serious kernel work.</span>
        <span class="hljs-comment">// LAB 4: Your code here.</span>
        lock_kernel();
        assert(curenv);
}
</code></pre>
<p>&#x4E00;&#x5904;&#x89E3;&#x9501;&#xFF1A;</p>
<ol>
<li>&#x4ECE;&#x5185;&#x6838;&#x5230;&#x7528;&#x6237;&#x6001;&#xFF1A;</li>
</ol>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">env_run</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span>
</span>{
     curenv-&gt;env_status = ENV_RUNNING;
    ++curenv-&gt;env_runs;
    lcr3(PADDR(curenv-&gt;env_pgdir));
    unlock_kernel();
    env_pop_tf(&amp;curenv-&gt;env_tf);
}
</code></pre>
<p>Q2&#xFF1A; &#x76EE;&#x524D;&#x7684;&#x9501;&#x673A;&#x5236;&#xFF0C;&#x4F7F;&#x5F97;&#x6BCF;&#x4E00;&#x6B21;&#x53EA;&#x6709;&#x4E00;&#x4E2A;CPU&#x8FD0;&#x884C;&#x5185;&#x6838;&#x4EE3;&#x7801;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x4ECD;&#x7136;&#x9700;&#x8981;&#x5C06;CPU&#x6808;&#x5206;&#x79BB;&#x5F00;&#xFF1F;&#x5982;&#x679C;&#x4E0D;&#x5206;&#x5F00;&#x6709;&#x4EC0;&#x4E48;&#x9519;&#xFF1F;</p>
<p>A&#xFF1A;lab3&#x4E2D;&#xFF0C;&#x5185;&#x6838;&#x6001;-&gt;&#x7CFB;&#x7EDF;&#x6001;&#x4E00;&#x5B9A;&#x662F;&#x4ECE;&#x6808;&#x7684;&#x6700;&#x9876;&#x7AEF;&#x5F00;&#x59CB;&#x7684;(KSTACKTOP)&#xFF0C;&#x56E0;&#x6B64;&#x6BCF;&#x4E00;&#x6B21;&#x9677;&#x5165;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x50CF;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4ECE;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x6838;&#x6808;&#x3002;&#x8FD9;&#x6837;&#x770B;&#x7684;&#x8BDD;&#xFF0C;&#x597D;&#x50CF;&#x662F;&#x80FD;&#x591F;&#x8FDB;&#x884C;&#x516C;&#x7528;&#x7684;&#x3002;&#x4F46;&#x662F;&#x4E0D;&#x8981;&#x5FD8;&#x4E86;&#x670B;&#x53CB;&#x4EEC;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x62A2;&#x5360;&#x5F0F;&#x8FDB;&#x884C;&#x8C03;&#x5EA6;&#xFF0C;&#x90A3;&#x4E48;&#x5185;&#x6838;&#x6808;&#x4E2D;&#x548C;&#x6709;&#x53EF;&#x80FD;&#x4FDD;&#x5B58;&#x7740;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x6216;&#x8005;&#x662F;&#x4E0A;&#x6B21;&#x672A;&#x6267;&#x884C;&#x5B8C;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x5982;&#x679C;&#x8C03;&#x7528;system call&#x90A3;&#x4E48;&#x538B;&#x5165;&#x7684;&#x53C2;&#x6570;&#x5C31;&#x4E0D;&#x4E00;&#x6837;&#x554A;&#xFF0C;&#x663E;&#x7136;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x6808;&#x3002;</p>
<h4 id="round-robin-scheduling">Round-Robin Scheduling</h4>
<p>Round-Robin&#x5C31;&#x662F;&#x5FAA;&#x5E8F;&#x7684;&#x8FDB;&#x884C;&#x8C03;&#x5EA6;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x8C03;&#x5EA6;&#x7684;&#x90FD;&#x662F;&#x5747;&#x7B49;&#x7684;&#x3002;</p>
<p>&#x6267;&#x884C;&#x7684;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><code>sched_yield()</code>&#x6311;&#x9009;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x8FDB;&#x884C;&#x6267;&#x884C;&#xFF0C;&#x901A;&#x8FC7;&#x73AF;&#x5F62;&#x7684;&#x65B9;&#x5F0F;&#x5BF9;envs[]&#x8FDB;&#x884C;&#x8BBF;&#x95EE;&#xFF0C;&#x6311;&#x9009;&#x7B2C;&#x4E00;&#x4E2A;&#x72B6;&#x6001;&#x4E3A;<code>RUNNABLE</code>&#x7684;&#x8FDB;&#x7A0B;&#x653E;&#x5165;&#x5230;&#x76EE;&#x524D;CPU&#x4E2D;&#x8FDB;&#x884C;&#x6267;&#x884C;&#x3002;</li>
<li><code>sched_yield()</code>&#x4E0D;&#x80FD;&#x5728;&#x4E24;&#x4E2A;CPU&#x4E0A;&#x8FD0;&#x884C;&#x540C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;</li>
<li>&#x7CFB;&#x7EDF;&#x5DF2;&#x7ECF;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;<code>sys_yield()</code>&#xFF0C;&#x4F7F;&#x5F97;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x80FD;&#x591F;&#x4E3B;&#x52A8;&#x7684;&#x8C03;&#x7528;<code>sched_yeild()</code>&#x5E76;&#x4E14;&#x8BA9;&#x5176;&#x4ED6;&#x7684;&#x8FDB;&#x7A0B;&#x88AB;CPU&#x6267;&#x884C;&#x3002;</li>
</ul>
<h4 id="exercise-6">exercise 6</h4>
<blockquote>
<p>&#x5B8C;&#x6210;sched_yield()&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x73B0;Round-Robin&#x8C03;&#x5EA6;</p>
</blockquote>
<p>&#x9996;&#x5148;&#x5B8C;&#x6210;&#x8C03;&#x5EA6;&#x7684;&#x7A0B;&#x5E8F;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// Choose a user environment to run and run it.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">sched_yield</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">struct</span> Env *idle;

    <span class="hljs-comment">// Implement simple round-robin scheduling.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Search through &apos;envs&apos; for an ENV_RUNNABLE environment in</span>
    <span class="hljs-comment">// circular fashion starting just after the env this CPU was</span>
    <span class="hljs-comment">// last running.  Switch to the first such environment found.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// If no envs are runnable, but the environment previously</span>
    <span class="hljs-comment">// running on this CPU is still ENV_RUNNING, it&apos;s okay to</span>
    <span class="hljs-comment">// choose that environment.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Never choose an environment that&apos;s currently running on</span>
    <span class="hljs-comment">// another CPU (env_status == ENV_RUNNING). If there are</span>
    <span class="hljs-comment">// no runnable environments, simply drop through to the code</span>
    <span class="hljs-comment">// below to halt the cpu.</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">int</span> counter;

    <span class="hljs-keyword">if</span> (curenv) {
        <span class="hljs-keyword">for</span> (counter = ENVX(curenv-&gt;env_id) + <span class="hljs-number">1</span>;
                counter != ENVX(curenv-&gt;env_id);
                counter = (counter + <span class="hljs-number">1</span>) % NENV){
            <span class="hljs-comment">//cprintf(&quot;%d\n&quot;, counter);</span>
            <span class="hljs-keyword">if</span> (envs[counter].env_status == ENV_RUNNABLE){
                env_run(envs + counter);
            }
        }
        <span class="hljs-keyword">if</span>(curenv-&gt;env_status != ENV_NOT_RUNNABLE)
            env_run(curenv);
            <span class="hljs-comment">//cprintf(&quot;%d\n&quot;, counter);</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (counter = <span class="hljs-number">0</span>; counter &lt; NENV; ++counter)
            <span class="hljs-keyword">if</span> (envs[counter].env_status == ENV_RUNNABLE)
                env_run(envs + counter);
    }
    <span class="hljs-comment">// sched_halt never returns</span>

    sched_halt();
}
</code></pre>
<p>&#x7136;&#x540E;&#xFF0C;&#x5728;syscall &#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;case &#x6765;&#x4F7F;&#x7528;sys_yield &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">case</span> SYS_yield:
    sys_yield();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>&#x4E4B;&#x540E;&#x5728;i386_init()&#x51FD;&#x6570;&#x4E2D;&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-c">ENV_CREATE(user_yield, ENV_TYPE_USER);
ENV_CREATE(user_yield, ENV_TYPE_USER);
ENV_CREATE(user_yield, ENV_TYPE_USER);
</code></pre>
<p>&#x8F93;&#x5165;<code>make qemu CPUS=2</code>&#x5C31;&#x80FD;&#x770B;&#x5230;&#x4E0B;&#x9762;&#x7684;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x4E86;&#xFF1A;</p>
<pre><code>Hello, I am environment 00001000.
Hello, I am environment 00001001.
Hello, I am environment 00001002.
Back in environment 00001000, iteration 0.
Back in environment 00001001, iteration 0.
Back in environment 00001002, iteration 0.
Back in environment 00001000, iteration 1.
Back in environment 00001001, iteration 1.
Back in environment 00001002, iteration 1.
...
</code></pre><p>Q3&#xFF1A;&#x5728;env_run()&#x4E2D;&#x4F7F;&#x7528;&#x4E86;<code>lcr3()</code>&#x7528;&#x6765;&#x66F4;&#x65B0;&#x9875;&#x76EE;&#x5F55;&#xFF0C;&#x56E0;&#x6B64;MMU&#x5185;&#x5BB9;&#x4F1A;&#x7ACB;&#x523B;&#x88AB;&#x66F4;&#x65B0;&#x3002;&#x90A3;&#x4E48;&#x4E3A;&#x4EC0;&#x4E48;&#x66F4;&#x65B0;&#x524D;&#x540E;&#x5F53;&#x524D;&#x51C6;&#x5907;&#x8FD0;&#x884C;&#x7684;environment&#x865A;&#x62DF;&#x5730;&#x5740;&#x6620;&#x5C04;&#x5230;&#x7269;&#x7406;&#x5730;&#x5740;&#x6CA1;&#x6709;&#x53D8;&#x5316;&#xFF1F;</p>
<p>&#x56E0;&#x4E3A;&#x5728;&#x8FDB;&#x7A0B;&#x9875;&#x76EE;&#x5F55;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x590D;&#x5236;&#x7684;&#x5C31;&#x662F;&#x5185;&#x6838;&#x7684;&#x9875;&#x76EE;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-c">e-&gt;env_pgdir = (<span class="hljs-keyword">pde_t</span> *)page2kva(p);
<span class="hljs-built_in">memcpy</span>(e-&gt;env_pgdir, kern_pgdir, PGSIZE);
</code></pre>
<p>&#x4EC5;&#x4EC5;&#x5728;UVPT&#x8FD9;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x6709;&#x4E86;&#x4FEE;&#x6539;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x770B;&#x770B;<code>env_create.env_alloc.env_setup_vm</code></p>
<p>&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5E94;&#x8BE5;&#x5728;lab3&#x5982;&#x4F55;&#x521D;&#x59CB;&#x5316;environment&#x5C31;&#x80FD;&#x591F;&#x56DE;&#x7B54;&#x3002;</p>
<p>Q4&#xFF1A;&#x5F53;CPU&#x4ECE;&#x4E00;&#x4E2A;environment&#x8F6C;&#x79FB;&#x5230;&#x4E86;&#x53E6;&#x5916;&#x4E00;&#x4E2A;environment&#xFF0C;&#x7CFB;&#x7EDF;&#x5FC5;&#x987B;&#x8981;&#x4FDD;&#x5B58;&#x65E7;&#x7684;environment&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4F7F;&#x5F97;&#x5B83;&#x4E4B;&#x540E;&#x80FD;&#x591F;&#x6B63;&#x786E;&#x7684;&#x88AB;&#x518D;&#x6B21;&#x5524;&#x8D77;&#x3002;&#x8FD9;&#x4E2A;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x8FDB;&#x884C;&#x7684;&#x3002;</p>
<p>&#x5728;env-&gt;env_tf&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;Trapframe&#x7ED3;&#x6784;&#x3002;&#x4FDD;&#x5B58;&#x662F;&#x53D1;&#x751F;&#x5728;_alltraps&#x6784;&#x9020;Trapframe&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5728;lab3&#x4E2D;&#x8BE6;&#x7EC6;&#x7684;&#x8BA8;&#x8BBA;&#x8FC7;&#x4E86;&#x3002;&#x6062;&#x590D;&#x53D1;&#x751F;&#x5728;kern/env.c &#x4E2D;&#x7684;<code>env_pop_tf</code>&#x5904;&#x3002;</p>
<h4 id="system-calls-for-environment-creation">System Calls for Environment Creation</h4>
<p>&#x73B0;&#x5728;&#x80FD;&#x8FDB;&#x884C;&#x8FDB;&#x7A0B;&#x7684;&#x5207;&#x6362;&#xFF0C;&#x4F46;&#x662F;&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#x6570;&#x5728;&#x7CFB;&#x7EDF;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x5DF2;&#x7ECF;&#x786E;&#x5B9A;&#x597D;&#x4E86;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x5728;&#x7528;&#x6237;&#x6001;&#x521B;&#x5EFA;&#x65B0;&#x7684;environment&#x3002;</p>
<p>Unix&#x4F7F;&#x7528;fork()&#x6765;&#x8FDB;&#x884C;&#x521B;&#x5EFA;&#x3002;&#x8BE5;&#x51FD;&#x6570;&#x4F1A;&#x8D4B;&#x503C;&#x6574;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x4F5C;&#x4E3A;child process&#x3002;parent process&#x548C;child process&#x7684;&#x533A;&#x522B;&#x5C31;&#x662F;process ID&#x3002;&#x5728;parent&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;fork&#x8FD4;&#x56DE;child ID&#xFF0C;&#x5728;child process&#x4E2D;&#xFF0C;fork&#x8FD4;&#x56DE;0(<code>environment-&gt;env_tf.tf_regs.reg_eax = 0;</code>)&#x3002;</p>
<p>&#x5728;JOS&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x4E0B;&#x9762;&#x7684;system call:</p>
<ul>
<li><code>sys_exofork</code>: </li>
</ul>
<p>&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x7A7A;&#x767D;&#x7684;&#x8FDB;&#x7A0B;&#x7A7A;&#x95F4;&#x3002;</p>
<p>&#x8C03;&#x7528;&#x7684;parent env&#x4F1A;&#x83B7;&#x5F97;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FDB;&#x7A0B;&#x53F7;&#xFF0C;&#x800C;&#x5B50;&#x8FDB;&#x7A0B;&#x5F97;&#x5230;&#x7684;&#x6570;&#x503C;&#x4E3A;0&#x3002;</p>
<ul>
<li><code>sys_env_set_status</code>&#xFF1A; &#x5F53;&#x521D;&#x59CB;&#x5316;&#x597D;&#x4E86;&#x82E5;&#x5E72;&#x7684;&#x9875;&#x9762;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x8FDB;&#x7A0B;&#x7684;&#x72B6;&#x6001;<code>ENV_NOT_RUNNABLE</code>&#x6539;&#x4F4D;<code>ENV_RUNNABLE</code>&#x3002;</li>
</ul>
<ul>
<li><p><code>sys_page_alloc</code>: &#x6839;&#x636E;&#x76F8;&#x5E94;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x914D;&#x76F8;&#x5E94;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x3002;</p>
</li>
<li><p><code>sys_page_map</code>: </p>
</li>
</ul>
<p>&#x611F;&#x89C9;&#x662F;&#x4E00;&#x79CD;&#x5185;&#x5B58;&#x5171;&#x4EAB;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x9875;&#x76EE;&#x5F55;&#x6620;&#x5C04;&#x6709;&#x540C;&#x4E00;&#x5757;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;</p>
<ul>
<li><code>sys_page_unmap</code>: </li>
</ul>
<p>&#x4E0E;&#x4E0A;&#x9762;&#x7684;&#x76F8;&#x53CD;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x7684;&#x6240;&#x6709;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x53C2;&#x6570;&#x4E2D;&#x90FD;&#x4F1A;&#x5305;&#x62EC;environment IDs&#x3002;JOS&#x63D0;&#x4F9B;ID&#x5230;environment&#x7684;&#x8F6C;&#x6362;&#xFF0C;&#x4F7F;&#x7528;<code>envid2env()</code>&#x3002;</p>
<p>&#x7279;&#x522B;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;<code>envid2env(0)</code>&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x5F53;&#x524D;environment&#x7684;&#x6307;&#x9488;&#x3002;</p>
<p>JOS&#x6B64;&#x523B;&#x5DF2;&#x7ECF;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x7B80;&#x964B;&#x7684;&#x50CF;<code>fork()</code>&#x90A3;&#x6837;&#x7684;&#x5B9E;&#x73B0;<code>dumbfork()</code>&#xFF08;&#x4E3A;&#x4EC0;&#x4E48;&#x8BF4;&#x7B80;&#x964B;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;copy on write&#x7684;&#x673A;&#x5236;&#xFF09;&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x4E0A;&#x9762;&#x7684;system call&#x4F7F;&#x5F97;&#x80FD;&#x591F;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x7B80;&#x964B;&#x7684;dumbfork()&#x3002;</p>
<h4 id="exercise-7">exercise 7</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;&#x4E0A;&#x9762;&#x7684;system call&#x3002;</p>
<p>&#x5F53;&#x8C03;&#x7528;envid2env&#x51FD;&#x6570;&#x7684;&#x65F6;&#x5019;&#xFF0C;checkperm=1&#xFF0C;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x59CB;&#x7EC8;&#x68C0;&#x67E5;environment&#x5173;&#x7CFB;&#x3002;</p>
<p>&#x68C0;&#x67E5;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x53C2;&#x6570;&#x4E0D;&#x6B63;&#x786E;&#x6216;&#x8005;&#x4E0D;&#x5728;&#x89C4;&#x5B9A;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8FD4;&#x56DE;<code>-E_INVAL</code>&#x3002;</p>
</blockquote>
<p>&#x9996;&#x5148;&#x5B9E;&#x73B0;<code>sys_exofork()</code>:</p>
<pre><code class="lang-c"><span class="hljs-comment">// Allocate a new environment.</span>
<span class="hljs-comment">// Returns envid of new environment, or &lt; 0 on error.  Errors are:</span>
<span class="hljs-comment">//    -E_NO_FREE_ENV if no free environment is available.</span>
<span class="hljs-comment">//    -E_NO_MEM on memory exhaustion.</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> envid_t
<span class="hljs-title">sys_exofork</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">// Create the new environment with env_alloc(), from kern/env.c.</span>
    <span class="hljs-comment">// It should be left as env_alloc created it, except that</span>
    <span class="hljs-comment">// status is set to ENV_NOT_RUNNABLE, and the register set is copied</span>
    <span class="hljs-comment">// from the current environment -- but tweaked so sys_exofork</span>
    <span class="hljs-comment">// will appear to return 0.</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">struct</span> Env *environment;
    <span class="hljs-keyword">int</span> res;
    <span class="hljs-keyword">if</span>((res = env_alloc(&amp;environment, curenv-&gt;env_id)) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> res;
    environment-&gt;env_status = ENV_NOT_RUNNABLE;
    environment-&gt;env_tf = curenv-&gt;env_tf;
    environment-&gt;env_tf.tf_regs.reg_eax = <span class="hljs-number">0</span>;<span class="hljs-comment">//&#x8FD9;&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4E86;</span>
    <span class="hljs-keyword">return</span> environment-&gt;env_id;
    <span class="hljs-comment">//panic(&quot;sys_exofork not implemented&quot;);</span>
}
</code></pre>
<p>&#x4E4B;&#x540E;&#x5B9E;&#x73B0;<code>sys_page_alloc()</code>:</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sys_page_alloc</span><span class="hljs-params">(envid_t envid, <span class="hljs-keyword">void</span> *va, <span class="hljs-keyword">int</span> perm)</span>
</span>{
    <span class="hljs-comment">// Hint: This function is a wrapper around page_alloc() and</span>
    <span class="hljs-comment">//   page_insert() from kern/pmap.c.</span>
    <span class="hljs-comment">//   Most of the new code you write should be to check the</span>
    <span class="hljs-comment">//   parameters for correctness.</span>
    <span class="hljs-comment">//   If page_insert() fails, remember to free the page you</span>
    <span class="hljs-comment">//   allocated!</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">if</span>(!(perm &amp; PTE_U) || !(perm &amp; PTE_U) ||
            (perm &amp; (~PTE_SYSCALL)) ||
            va &gt; (<span class="hljs-keyword">void</span> *)UTOP ||
            va != ROUNDDOWN(va, PGSIZE))
        <span class="hljs-keyword">return</span> -E_INVAL;
    <span class="hljs-keyword">struct</span> PageInfo *pginfo = page_alloc(ALLOC_ZERO);
    <span class="hljs-keyword">if</span>(!pginfo)
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    <span class="hljs-keyword">struct</span> Env *environment;
    <span class="hljs-keyword">if</span>(envid2env(envid, &amp;environment, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -E_BAD_ENV;
    <span class="hljs-keyword">if</span>(page_insert(environment-&gt;env_pgdir, pginfo, va, perm) &lt; <span class="hljs-number">0</span>){
        page_free(pginfo);
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//panic(&quot;sys_page_alloc not implemented&quot;);</span>
}
</code></pre>
<p><code>sys_page_map</code>&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sys_page_map</span><span class="hljs-params">(envid_t srcenvid, <span class="hljs-keyword">void</span> *srcva,
         envid_t dstenvid, <span class="hljs-keyword">void</span> *dstva, <span class="hljs-keyword">int</span> perm)</span>
</span>{
    <span class="hljs-comment">// Hint: This function is a wrapper around page_lookup() and</span>
    <span class="hljs-comment">//   page_insert() from kern/pmap.c.</span>
    <span class="hljs-comment">//   Again, most of the new code you write should be to check the</span>
    <span class="hljs-comment">//   parameters for correctness.</span>
    <span class="hljs-comment">//   Use the third argument to page_lookup() to</span>
    <span class="hljs-comment">//   check the current permissions on the page.</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">if</span>((<span class="hljs-keyword">uint32_t</span>)srcva &gt;= UTOP || PGOFF(srcva) ||
            (<span class="hljs-keyword">uint32_t</span>)dstva &gt;= UTOP || PGOFF(dstva) ||
            !(perm &amp; PTE_U) ||
            (perm &amp; (~PTE_SYSCALL)) )
        <span class="hljs-keyword">return</span> -E_INVAL;
    <span class="hljs-keyword">struct</span> Env *src_environemt, *dst_environment;
    <span class="hljs-keyword">if</span>(envid2env(srcenvid, &amp;src_environemt, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||
            envid2env(dstenvid, &amp;dst_environment, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -E_BAD_ENV;
    <span class="hljs-keyword">pte_t</span> *pte;
    <span class="hljs-keyword">struct</span> PageInfo *page = page_lookup(src_environemt-&gt;env_pgdir, srcva, &amp;pte);
    <span class="hljs-comment">// if(srcenvid == 4097)</span>
    <span class="hljs-comment">//     *pte |= PTE_W;</span>
    <span class="hljs-keyword">if</span>(!page || (!(*pte &amp; PTE_W) &amp;&amp; (perm &amp; PTE_W)))
        <span class="hljs-keyword">return</span> -E_INVAL;
    <span class="hljs-keyword">if</span>(page_insert(dst_environment-&gt;env_pgdir, page, dstva, perm) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//panic(&quot;sys_page_map not implemented&quot;);</span>
}
</code></pre>
<p><code>sys_page_unmap</code>:</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sys_page_unmap</span><span class="hljs-params">(envid_t envid, <span class="hljs-keyword">void</span> *va)</span>
</span>{
    <span class="hljs-comment">// Hint: This function is a wrapper around page_remove().</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">if</span>((<span class="hljs-keyword">uint32_t</span>)va &gt;= UTOP || PGOFF(va))
        <span class="hljs-keyword">return</span> -E_INVAL;
    <span class="hljs-keyword">struct</span> Env *environment;
    <span class="hljs-keyword">if</span>(envid2env(envid, &amp;environment, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -E_BAD_ENV;
    page_remove(environment-&gt;env_pgdir, va);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//panic(&quot;sys_page_unmap not implemented&quot;);</span>
}
</code></pre>
<p>&#x6700;&#x540E;&#x589E;&#x52A0;&#x8FD9;&#x51E0;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5206;&#x53D1;&#xFF1A;</p>
<pre><code class="lang-c">        <span class="hljs-keyword">case</span> SYS_exofork:
            <span class="hljs-keyword">return</span> sys_exofork();
        <span class="hljs-keyword">case</span> SYS_env_set_status:
            <span class="hljs-keyword">return</span> sys_env_set_status(a1, a2);
        <span class="hljs-keyword">case</span> SYS_page_alloc:
            <span class="hljs-keyword">return</span> sys_page_alloc(a1, (<span class="hljs-keyword">void</span> *) a2, a3);
        <span class="hljs-keyword">case</span> SYS_page_map:
            <span class="hljs-keyword">return</span> sys_page_map(a1, (<span class="hljs-keyword">void</span> *) a2, a3, (<span class="hljs-keyword">void</span> *) a4, a5);
        <span class="hljs-keyword">case</span> SYS_page_unmap:
            <span class="hljs-keyword">return</span> sys_page_unmap(a1, (<span class="hljs-keyword">void</span> *) a2);
</code></pre>
<h3 id="part-b-copy-on-write-fork">Part B: Copy-on-Write Fork</h3>
<p>Unix&#x63D0;&#x4F9B;fork()&#x6765;&#x5728;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x884C;&#x8FDB;&#x7A0B;&#x7684;&#x521B;&#x5EFA;&#x3002;</p>
<p>vx6&#x901A;&#x8FC7;&#x8D4B;&#x503C;&#x6240;&#x6709;parent&#x7684;&#x9875;&#x8FDB;&#x5165;&#x65B0;&#x7684;&#x9875;&#xFF0C;&#x4ECE;&#x800C;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x8FDB;&#x7A0B;&#x3002;&#x5E76;&#x4E14;&#x8FD9;&#x6837;&#x7684;&#x590D;&#x5236;&#x884C;&#x4E3A;&#x4EE3;&#x4EF7;&#x4E5F;&#x662F;&#x6574;&#x4E2A;fork()&#x5F00;&#x9500;&#x6700;&#x5927;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x7136;&#x800C;&#xFF0C;&#x4E00;&#x4E2A;fork()&#x51FD;&#x6570;&#x8C03;&#x7528;&#x540E;&#x5F80;&#x5F80;&#x8DDF;&#x968F;&#x7740;&#x4E00;&#x4E2A;exec()&#x51FD;&#x6570;&#xFF0C;&#x53C8;&#x9700;&#x8981;&#x5C06;&#x539F;&#x6765;&#x7684;&#x5185;&#x5B58;&#x66FF;&#x6362;&#x4E3A;&#x5176;&#x4ED6;&#x5185;&#x5BB9;&#x3002;&#x56E0;&#x4E3A;child process&#x5BF9;parent process&#x62F7;&#x8D1D;&#x540E;&#x7684;&#x5185;&#x5BB9;&#x7528;&#x7684;&#x975E;&#x5E38;&#x7684;&#x5C11;&#xFF0C;&#x56E0;&#x6B64;&#x5C06;&#x6574;&#x4E2A;&#x9875;&#x5185;&#x5BB9;&#x90FD;&#x62F7;&#x8D1D;&#x8FC7;&#x6765;&#x5C06;&#x662F;&#x662F;&#x975E;&#x6D6A;&#x8D39;&#x6548;&#x7387;&#x7684;&#x4E00;&#x79CD;&#x884C;&#x4E3A;&#x3002;</p>
<p>&#x6B63;&#x662F;&#x4E0A;&#x9762;&#x9047;&#x5230;&#x7684;&#x8FD9;&#x79CD;&#x95EE;&#x9898;&#xFF0C;&#x4E4B;&#x540E;&#x7684;unix&#x5229;&#x7528;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7684;&#x786C;&#x4EF6;&#xFF0C;&#x4F7F;&#x5F97;parent&#x548C;child process&#x80FD;&#x591F;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x76F4;&#x5230;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4FEE;&#x6539;&#x4E86;&#x9875;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5C31;&#x4F1A;&#x7ED3;&#x675F;&#x5171;&#x4EAB;&#x9875;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x8FD9;&#x79CD;&#x884C;&#x4E3A;&#x53EB;&#x505A;copy-on-write&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x5B9E;&#x73B0;&#x4E0A;&#x9762;&#x7684;&#x529F;&#x80FD;&#xFF0C;fork()&#x5B9E;&#x73B0;&#x65F6;&#xFF0C;&#x5185;&#x6838;&#x5C06;&#x4F1A;&#x8D4B;&#x503C;parent&#x7684;address space mappings&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x9875;&#x76EE;&#x5F55;&#x548C;&#x9875;&#x8868;&#x5230;child process&#xFF0C;&#x800C;&#x4E0D;&#x5C06;&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x5230;child process&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x5185;&#x5BB9;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x4E3A;<code>read-only</code>&#x3002;&#x5F53;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5C1D;&#x8BD5;&#x5BF9;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x5199;&#x7684;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x4F1A;&#x53D1;&#x751F;<code>page falut</code>&#x4E2D;&#x65AD;&#x3002;&#x5E76;&#x4E14;&#x5206;&#x914D;&#x65B0;&#x7684;&#x9875;&#xFF0C;&#x8FD9;&#x4E9B;&#x5185;&#x5BB9;&#x8BBE;&#x7F6E;&#x4E3A;&#x53EF;&#x5199;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x63CF;&#x8FF0;&#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x5F97;&#x4E00;&#x822C;fork()&#x64CD;&#x4F5C;&#x7684;&#x5F00;&#x9500;&#x975E;&#x5E38;&#x7684;&#x5C0F;&#xFF0C;&#x4E00;&#x822C;&#x53EA;&#x7528;&#x590D;&#x5236;1page&#xFF08;4096Bytes&#xFF09;&#x3002;</p>
<h4 id="user-level-page-fault-handling">User-level page fault handling</h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x5B9E;&#x73B0;&#x4E0A;&#x9762;&#x7684;copy-on-write&#xFF0C;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x9700;&#x8981;&#x77E5;&#x9053;&#x5728;read-only&#x7684;&#x9875;&#x4E0A;&#x4F1A;&#x53D1;&#x751F;page fault&#x7684;&#x9519;&#x8BEF;&#x3002;</p>
<p>&#x5E76;&#x4E14;&#x53D1;&#x751F;page fault&#x8FD9;&#x79CD;&#x65F6;&#x95F4;&#x4E5F;&#x662F;&#x975E;&#x5E38;&#x5E38;&#x89C1;&#x7684;&#xFF0C;&#x6BD4;&#x5982;&#x4E00;&#x822C;&#x5185;&#x6838;&#x5728;&#x521D;&#x59CB;&#x5316;&#x7A0B;&#x5E8F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4EC5;&#x4F1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x9875;&#xFF0C;&#x5F53;&#x6808;&#x7A7A;&#x95F4;&#x4E0D;&#x591F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x53D1;&#x751F;page fault&#x3002;&#x540C;&#x7406;&#xFF0C;&#x8FD9;&#x4E9B;&#x4E8B;&#x4EF6;&#x4E5F;&#x4F1A;&#x53D1;&#x751F;&#x5728;BSS&#x533A;&#x57DF;&#xFF0C;&#x5E76;&#x4E14;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5168;&#x90E8;&#x8D4B;&#x503C;&#x4E3A;0&#x3002;&#x5F53;&#x9700;&#x8981;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x4E0D;&#x5728;&#x5185;&#x5B58;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x4F1A;&#x53D1;&#x751F;page fault&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x4ECE;&#x78C1;&#x76D8;&#x8BFB;&#x53D6;&#x76F8;&#x5173;&#x6307;&#x4EE4;&#x3002;&#x53EF;&#x89C1;page fault&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x5E38;&#x89C1;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x4F18;&#x5316;&#x7CFB;&#x7EDF;&#x6027;&#x80FD;&#x7684;&#x624B;&#x6BB5;&#x3002;</p>
<p>JOS&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x4F1A;&#x5728;&#x5185;&#x6838;&#x6001;&#x5C01;&#x88C5;page fault handler&#xFF0C;&#x76F8;&#x53CD;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x7528;&#x6237;&#x6001;&#x53EF;&#x4EE5;<strong>&#x81EA;&#x7531;&#x7684;&#x5B9A;&#x5236;page fault</strong> handler&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x597D;&#x597D;&#x7684;&#x8BBE;&#x8BA1;page fault&#x7684;&#x5904;&#x7406;&#x673A;&#x5236;&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x7075;&#x6D3B;&#x7684;&#x5904;&#x7406;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684;&#x591A;&#x79CD;&#x53D1;&#x751F;page fault&#x60C5;&#x51B5;&#x7684;&#x4E8B;&#x4EF6;&#x3002;</p>
<p>&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5904;&#x7406;&#x83B7;&#x53D6;&#x4ECE;&#x786C;&#x76D8;&#x4E0A;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<h4 id="setting-the-page-fault-handler">Setting the Page Fault Handler</h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x7528;&#x6237;&#x6001;&#x6709;&#x81EA;&#x5DF1;&#x7684;page fault handler&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;JOS&#x5185;&#x6838;&#x7684;page fault handler entrypoint&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x786E;&#x5B9A;&#xFF08;&#x5C31;&#x662F;&#x51FD;&#x6570;&#x6307;&#x9488;&#x7684;&#x8D4B;&#x503C;&#xFF09;&#x3002;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x901A;&#x8FC7;<code>sys_env_set_pgfault_upcall</code>&#x6CE8;&#x518C;&#x81EA;&#x5DF1;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;&#x5E76;&#x4E14;&#x5728;Env&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x53D8;&#x91CF;<code>env_pgfault_upcall</code>&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x8FD9;&#x4E2A;&#x503C;&#x3002;</p>
<h4 id="exercise-8">exercise 8</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>sys_env_set_pgfault_upcall</code>&#xFF0C;&#x786E;&#x4FDD;&#x6743;&#x9650;&#x7684;&#x68C0;&#x67E5;&#xFF0C;&#x4F7F;&#x5F97;&#x53EA;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x8FDB;&#x7A0B;ID&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x5371;&#x9669;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
</blockquote>
<p>&#x5728;<code>kern/syscall.c</code>&#x4E2D;&#x8FDB;&#x884C;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// Set the page fault upcall for &apos;envid&apos; by modifying the corresponding struct</span>
<span class="hljs-comment">// Env&apos;s &apos;env_pgfault_upcall&apos; field.  When &apos;envid&apos; causes a page fault, the</span>
<span class="hljs-comment">// kernel will push a fault record onto the exception stack, then branch to</span>
<span class="hljs-comment">// &apos;func&apos;.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Returns 0 on success, &lt; 0 on error.  Errors are:</span>
<span class="hljs-comment">//    -E_BAD_ENV if environment envid doesn&apos;t currently exist,</span>
<span class="hljs-comment">//        or the caller doesn&apos;t have permission to change envid.</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sys_env_set_pgfault_upcall</span><span class="hljs-params">(envid_t envid, <span class="hljs-keyword">void</span> *func)</span>
</span>{
    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">struct</span> Env *environment;
    <span class="hljs-keyword">if</span>(envid2env(envid, &amp;environment, <span class="hljs-number">1</span>))
        <span class="hljs-keyword">return</span> -E_BAD_ENV;
    environment-&gt;env_pgfault_upcall = func;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">// panic(&quot;sys_env_set_pgfault_upcall not implemented&quot;);</span>
}
</code></pre>
<p>&#x5E76;&#x4E14;&#x5728;<code>/kern/syscall.c/syscall()</code>&#x4E2D;&#x8FDB;&#x884C;&#x5206;&#x53D1;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">case</span> SYS_env_set_pgfault_upcall:
            <span class="hljs-keyword">return</span> sys_env_set_pgfault_upcall(a1, (<span class="hljs-keyword">void</span> *) a2);
</code></pre>
<h4 id="normal-and-exception-stacks-in-user-environments">Normal and Exception Stacks in User Environments</h4>
<p>&#x6B63;&#x5E38;&#x7528;&#x6237;&#x6001;&#x7684;&#x6808;&#x7A7A;&#x95F4;&#x5728;[USTACKTOP-1, USTACKTOP-PGSIZE]&#x4E4B;&#x95F4;&#x3002;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x6001;&#x4EA7;&#x751F;&#x4E2D;&#x65AD;&#xFF0C;&#x5185;&#x6838;&#x5C06;&#x4F1A;&#x5728;&#x4E00;&#x4E2A;&#x8BBE;&#x5B9A;&#x597D;&#x7684;&#x6808;&#x7A7A;&#x95F4;&#x91CD;&#x542F;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5728;<code>user exception stack</code>&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x548C;&#x7528;&#x6237;&#x6001;&#x5207;&#x6362;&#x5230;&#x5185;&#x6838;&#x6001;&#x539F;&#x7406;&#x57FA;&#x672C;&#x662F;&#x76F8;&#x540C;&#x7684;&#x3002;</p>
<p>user exception stack&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x9875;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x4E14;&#x6808;&#x5E95;&#x7684;&#x4F4D;&#x7F6E;&#x5728;<code>UXSTACKTOP</code>&#x3002;&#x7136;&#x540E;&#x5728;&#x8FD9;&#x4E2A;&#x6808;&#x7A7A;&#x95F4;&#xFF0C;&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x7684;&#x8C03;&#x7528;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x5BF9;&#x9875;&#x8FDB;&#x884C;&#x91CD;&#x65B0;&#x7684;&#x6620;&#x5C04;&#xFF0C;&#x5206;&#x914D;&#x6216;&#x8005;&#x662F;&#x4FEE;&#x590D;&#x4EFB;&#x4F55;&#x4E0E;page fault&#x6709;&#x5173;&#x95EE;&#x9898;&#x3002;user-level page handler&#x901A;&#x8FC7;&#x6C47;&#x7F16;&#x8BED;&#x8A00;stub&#x8FD4;&#x56DE;&#x76F8;&#x5E94;&#x7684;&#x503C;&#xFF0C;&#x4E5F;&#x662F;&#x539F;&#x6765;&#x6808;&#x4E0A;&#x9762;&#x586B;&#x9519;&#x8BEF;&#x7801;(<code>uint32_t tf_trapno</code>)&#x7684;&#x5730;&#x65B9;&#x3002;</p>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5982;&#x679C;&#x60F3;&#x8981;&#x652F;&#x6301;&#x7528;&#x6237;&#x6001;&#x7684;page fault handler&#xFF0C;&#x5FC5;&#x987B;&#x81EA;&#x5DF1;&#x5206;&#x914D;&#x76F8;&#x5E94;&#x7684;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>sys_page_alloc()</code>&#x8FDB;&#x884C;&#x5206;&#x914D;&#x3002;</p>
<h4 id="invoking-the-user-page-fault-handler">Invoking the User Page Fault Handler</h4>
<p>&#x6784;&#x9020;page fault handler&#x6808;&#x5982;&#x4E0B;&#x9762;&#x7ED3;&#x679C;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code>                    &lt;-- UXSTACKTOP
trap-time esp
trap-time eflags
trap-time eip
trap-time eax       start of struct PushRegs
trap-time ecx
trap-time edx
trap-time ebx
trap-time esp
trap-time ebp
trap-time esi
trap-time edi       end of struct PushRegs
tf_err (error code)
fault_va            &lt;-- %esp when handler is run
</code></pre><p>&#x4E0E;<code>/inc/trap.h</code>&#x91CC;&#x9762;&#x7ED3;&#x6784;&#x4F53;&#x53D8;&#x91CF;&#x7ED3;&#x6784;&#x4E00;&#x81F4;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">struct</span> UTrapframe {
    <span class="hljs-comment">/* information about the fault */</span>
    <span class="hljs-keyword">uint32_t</span> utf_fault_va;    <span class="hljs-comment">/* va for T_PGFLT, 0 otherwise */</span>
    <span class="hljs-keyword">uint32_t</span> utf_err;
    <span class="hljs-comment">/* trap-time return state */</span>
    <span class="hljs-keyword">struct</span> PushRegs utf_regs;
    <span class="hljs-keyword">uintptr_t</span> utf_eip;
    <span class="hljs-keyword">uint32_t</span> utf_eflags;
    <span class="hljs-comment">/* the trap-time stack to return to */</span>
    <span class="hljs-keyword">uintptr_t</span> utf_esp;
} __attribute__((packed));
</code></pre>
<p>&#x5F53;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x672A;&#x5B8C;&#x6210;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x5D4C;&#x5957;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x4E0D;&#x8FC7;&#x6B64;&#x65F6;&#x6808;&#x7684;&#x53D8;&#x5316;&#x662F;&#x4ECE;&#x6B64;&#x523B;&#x7684;<code>tf-&gt;tf_eps</code>&#x5411;&#x4E0B;&#x589E;&#x957F;&#x7684;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4ECE;<code>UXSTACKTOP</code>&#x5F00;&#x59CB;&#x5411;&#x4E0B;&#x53D8;&#x5316;&#xFF0C;&#x53CD;&#x6B63;&#x662F;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x5D4C;&#x5957;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<p>&#x786E;&#x4FDD;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x6808;&#x7684;&#x4E0B;&#x9762;&#x5C31;&#x662F;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x6808;&#xFF0C;&#x5982;&#x679C;&#x8986;&#x76D6;&#x4E86;&#x90A3;&#x4E48;&#x5373;&#x4F7F;&#x5F02;&#x5E38;&#x6B63;&#x786E;&#x7684;&#x5904;&#x7406;&#x4E86;&#xFF0C;&#x8FD4;&#x56DE;&#x540E;&#x7A0B;&#x5E8F;&#x4F9D;&#x65E7;&#x4E0D;&#x80FD;&#x591F;&#x6B63;&#x786E;&#x7684;&#x6267;&#x884C;&#x3002;</p>
<h4 id="exercise-9">exercise 9</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>/kern/trap.c</code>&#x4E2D;&#x7684;<code>page_fault_handler</code>&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x80FD;&#x591F;&#x5206;&#x53D1;&#x7528;&#x6237;&#x6001;&#x7684;page fault handler&#x3002;</p>
<p>&#x786E;&#x4FDD;&#x6B63;&#x786E;&#x7684;&#x5BF9;&#x6808;&#x7A7A;&#x95F4;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;</p>
<p>&#x5982;&#x679C; exception stack&#x4F7F;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x8D85;&#x8FC7;&#x4E86;&#x4F1A;&#x53D1;&#x751F;&#x4EC0;&#x4E48;&#xFF1F;&#xFF08;&#x4E0A;&#x9762;&#x56DE;&#x7B54;&#x4E86;&#xFF09;</p>
</blockquote>
<p>&#x901A;&#x8FC7;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x91CA;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5BF9;page fault&#x8FDB;&#x884C;&#x5206;&#x7C7B;&#x8BA8;&#x8BBA;&#x5904;&#x7406;&#xFF1A;</p>
<ul>
<li>&#x5F53;&#x521D;&#x6B21;&#x53D1;&#x751F;page fault handler&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x6808;&#x9677;&#x5165;&#x7684;&#x53D8;&#x5316;&#x65F6;&#x7528;&#x6237;&#x6808;-&gt;&#x5185;&#x6838;&#x6808;-&gt;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#xFF08;&#x8FD4;&#x56DE;&#x65F6;&#x5F02;&#x5E38;&#x6808;-&gt;&#x76F4;&#x63A5;&#x7528;&#x6237;&#x6808;&#xFF09;&#x3002;</li>
<li>&#x5F53;&#x6709;page fault handler&#x7684;&#x5D4C;&#x5957;&#x65F6;&#xFF0C;&#x6B64;&#x65F6;&#x5DF2;&#x7ECF;&#x5728;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#x4E86;&#xFF0C;&#x6B64;&#x65F6;&#x9700;&#x8981;&#x518D;&#x6B21;&#x538B;&#x5165;&#x4E00;&#x4E2A;UTrapframe&#xFF0C;&#x5E76;&#x4E14;&#x4E4B;&#x95F4;&#x7A7A;4Bytes&#xFF0C;&#x6B64;&#x65F6;&#x6808;&#x9677;&#x5165;&#x987A;&#x5E8F;&#x4E3A;&#xFF1A;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;-&gt;&#x5185;&#x6838;&#x6808;-&gt;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#xFF08;&#x6CE8;&#x610F;&#x8FD4;&#x56DE;&#x987A;&#x5E8F;&#x5E76;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x76F4;&#x63A5;&#x5F02;&#x5E38;&#x6808;-&gt;&#x4E00;&#x573A;&#x6808;&#xFF09;&#x3002;</li>
</ul>
<p>&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x8981;&#x65F6;&#x523B;&#x4FDD;&#x8BC1;&#x538B;&#x5165;&#x7684;UTrapgrame&#x6CA1;&#x6709;&#x8D85;&#x8FC7;&#x5185;&#x5B58;&#x9650;&#x5236;&#x5927;&#x5C0F;&#xFF0C;&#x6700;&#x7EC8;&#x7684;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// LAB 4: Your code here.</span>
<span class="hljs-keyword">if</span>(curenv-&gt;env_pgfault_upcall){
        <span class="hljs-keyword">struct</span> UTrapframe *utf;
        <span class="hljs-keyword">uintptr_t</span> addr;         <span class="hljs-comment">// addr of utf</span>
        <span class="hljs-keyword">if</span>(UXSTACKTOP - PGSIZE &lt;= tf-&gt;tf_esp &amp;&amp; tf-&gt;tf_esp &lt; UXSTACKTOP)
            addr = tf-&gt;tf_esp - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UTrapframe) - <span class="hljs-number">4</span>;
        <span class="hljs-keyword">else</span>
            addr = UXSTACKTOP - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UTrapframe);
        user_mem_assert(curenv, (<span class="hljs-keyword">void</span> *)addr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UTrapframe), PTE_W);
        utf = (<span class="hljs-keyword">struct</span> UTrapframe *)addr;
        utf-&gt;utf_fault_va = fault_va;
        utf-&gt;utf_err = tf-&gt;tf_err;
        utf-&gt;utf_regs = tf-&gt;tf_regs;
        utf-&gt;utf_eip = tf-&gt;tf_eip;<span class="hljs-comment">//&#x7528;&#x6237;&#x80FD;&#x591F;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6001;&#x7684;&#x8BBE;&#x7F6E;</span>
        utf-&gt;utf_eflags = tf-&gt;tf_eflags;
        utf-&gt;utf_esp = tf-&gt;tf_esp;

        tf-&gt;tf_eip = (<span class="hljs-keyword">uint32_t</span>)curenv-&gt;env_pgfault_upcall;
        tf-&gt;tf_esp = addr;
        env_run(curenv);
}
</code></pre>
<h4 id="user-mode-page-fault-entrypoint">User-mode Page Fault Entrypoint</h4>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF0C;&#x6765;&#x5BF9;page fault&#x6B63;&#x786E;&#x7684;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x4E14;&#x5904;&#x7406;&#x5B8C;&#x540E;&#x80FD;&#x591F;&#x6B63;&#x786E;&#x7684;&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x8FD9;&#x4E2A;assembly routine&#x5C06;&#x4F1A;&#x5728;sys_env_set_pgfault_upcall()&#x4E0A;register&#xFF08;&#x8D4B;&#x503C;&#xFF09;&#x4E0A;&#x3002;</p>
<h4 id="exercise-10">exercise 10</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>lib/pfentry.S</code>&#x4E2D;&#x7684;_pgfault_upcall&#x51FD;&#x6570;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x6709;&#x8DA3;&#x7684;&#x662F;&#x80FD;&#x591F;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#x5F02;&#x5E38;&#x5730;&#x5740;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5185;&#x6838;&#x8FDB;&#x884C;&#x8FD4;&#x56DE;&#x3002;&#xFF08;&#x6CE8;&#x610F;&#x9677;&#x5165;&#x548C;&#x8FD4;&#x56DE;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF09;</p>
<p>&#x6700;&#x96BE;&#x7684;&#x90E8;&#x5206;&#x662F;&#x540C;&#x65F6;&#x53D8;&#x6362;&#x6808;&#x548C;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;EIP&#x3002;&#xFF08;&#x6B64;&#x5904;&#x540C;&#x65F6;&#x53D8;&#x6362;&#x4E0D;&#x662F;&#x6307;&#x5185;&#x5B58;&#x53D8;&#x6362;&#xFF0C;&#x800C;&#x662F;&#x518D;&#x8FD8;&#x539F;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6709;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4E00;&#x65E6;&#x88AB;&#x8FD8;&#x539F;&#xFF0C;&#x5C31;&#x4E0D;&#x80FD;&#x518D;&#x7EE7;&#x7EED;&#x88AB;&#x4F7F;&#x7528;&#x4E86;&#xFF09;</p>
</blockquote>
<p>&#x5173;&#x4E8E;&#x8C03;&#x7528;page_fault_handler&#x8FC7;&#x7A0B;&#x6BD4;&#x8F83;&#x7684;&#x7B80;&#x5355;&#xFF1A;</p>
<ol>
<li>&#x7528;UTrapframe&#x6765;&#x4FDD;&#x5B58;&#x5F53;&#x524D;&#x7528;&#x6237;&#x6001;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x503C;&#x5B58;&#x50A8;&#x5728;&#x5F02;&#x5E38;&#x6808;&#x5904;&#x7406;&#x90E8;&#x5206;<code>UXSTACKTOP</code>&#x3002;</li>
<li>&#x66F4;&#x65B0;&#x7528;&#x6237;&#x6001;&#x7684;Tramframe&#x4E2D;&#x7684;EIP=page_fault_handler&#x548C;ESP(&#x5F02;&#x5E38;&#x6808;&#x90E8;&#x5206;)</li>
<li><code>_pgfault_upcall</code>&#x8C03;&#x7528;&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x5B9A;&#x4E49;&#x7684;<code>page_fault_handler</code>&#xFF0C;&#x5176;&#x4E2D;&#x4F20;&#x5165;&#x53C2;&#x6570;UTrapframe(<code>pushl %esp</code>)&#x3002;</li>
<li>&#x5904;&#x7406;&#x5B8C;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x4ECE;&#x5F02;&#x5E38;&#x6808;&#x8DF3;&#x8F6C;&#x5230;&#x7528;&#x6237;&#x6001;&#xFF08;&#x800C;&#x4E0D;&#x7528;&#x901A;&#x8FC7;&#x5185;&#x6838;&#x6001;&#x8FDB;&#x884C;&#x4E2D;&#x8F6C;&#xFF09;&#x3002;</li>
</ol>
<p>&#x8FD9;&#x4E2A;&#x8DF3;&#x8F6C;&#x7684;&#x90E8;&#x5206;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x6BD4;&#x8F83;&#x96BE;&#x7684;&#x90E8;&#x5206;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x8BB2;&#x8BB2;&#x5177;&#x4F53;&#x7684;&#x601D;&#x8DEF;&#x3002;</p>
<p>&#x5047;&#x8BBE;&#x73B0;&#x5728;&#x5F02;&#x5E38;&#x6808;&#x53EA;&#x538B;&#x5165;&#x4E86;&#x4E00;&#x4E2A;&#x6808;&#x5E27;&#xFF0C;&#x6B64;&#x523B;&#x7684;&#x6808;&#x957F;&#x6210;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code>                    &lt;-- UXSTACKTOP
                    4 Bytes
trap-time esp
trap-time eflags
trap-time eip
trap-time eax       start of struct PushRegs
trap-time ecx
trap-time edx
trap-time ebx
trap-time esp
trap-time ebp
trap-time esi
trap-time edi       end of struct PushRegs
tf_err (error code)
fault_va            &lt;-- %esp when handler is run
</code></pre><p>&#x9996;&#x5148;&#x6267;&#x884C;&#x56E0;&#x4E3A;&#x6808;&#x9876;&#x7684;&#x4E24;&#x4E2A;&#x6570;&#x636E;&#x5E76;&#x4E0D;&#x5F71;&#x54CD;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x8FD8;&#x539F;&#xFF0C;<code>addl $0x8, %esp</code>,&#x6808;&#x5185;&#x5BB9;&#x53D8;&#x6210;&#x8FD9;&#x6837;:</p>
<pre><code>                    &lt;-- UXSTACKTOP
                    4 Bytes
trap-time esp
trap-time eflags
trap-time eip
trap-time eax       start of struct PushRegs
trap-time ecx
trap-time edx
trap-time ebx
trap-time esp
trap-time ebp
trap-time esi
trap-time edi       &lt;-- %esp when handler is run
</code></pre><p>&#x4E4B;&#x540E;&#x6267;&#x884C;&#x4E0B;&#x9762;&#x8BED;&#x53E5;&#xFF1A;</p>
<pre><code>subl $0x4, 0x28(%esp)
movl 0x28(%esp), %edx
</code></pre><p>&#x6808;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x53D8;&#x6210;&#x4E86;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code>                    &lt;-- UXSTACKTOP
                    4 Bytes
trap-time esp-4
trap-time eflags
trap-time eip
trap-time eax       start of struct PushRegs
trap-time ecx
trap-time edx
trap-time ebx
trap-time esp
trap-time ebp
trap-time esi
trap-time edi       &lt;-- %esp when handler is run
</code></pre><p>&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x7684;&#x6307;&#x4EE4;&#xFF1A;</p>
<pre><code>movl 0x20(%esp), %eax
movl %eax, (%edx)
</code></pre><p>&#x6808;&#x4E2D;&#x5185;&#x5BB9;&#x53D8;&#x6210;&#x4E86;&#xFF1A;</p>
<pre><code>                    &lt;-- UXSTACKTOP
trap-time eip       4 Bytes //&#x8FD9;&#x91CC;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;
trap-time esp-4
trap-time eflags
trap-time eip
trap-time eax       start of struct PushRegs
trap-time ecx
trap-time edx
trap-time ebx
trap-time esp
trap-time ebp
trap-time esi
trap-time edi       &lt;-- %esp when handler is run
</code></pre><p>&#x7ECF;&#x5386;&#x4E0B;&#x9762;&#x7684;&#x6307;&#x4EE4;&#xFF1A;</p>
<pre><code>popal
addl $0x4, %esp
popfl
popl %esp
</code></pre><p>&#x6808;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x53D8;&#x6210;&#x4E86;&#xFF1A;</p>
<pre><code>                    &lt;-- UXSTACKTOP
trap-time eip       4 Bytes
</code></pre><p>&#x6700;&#x540E;&#x6267;&#x884C;ret&#xFF0C;&#x5C06;&#x6808;&#x9876;&#x7684;&#x5185;&#x5BB9;&#x8D4B;&#x503C;&#x7ED9;EIP&#xFF0C;&#x6700;&#x7EC8;&#x5B8C;&#x6210;&#x4E86;&#x8DF3;&#x8F6C;&#x3002;</p>
<p>&#x5F02;&#x5E38;&#x6808;&#x5728;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x989D;&#x5916;&#x7684;&#x591A;&#x5206;&#x914D;4Bytes&#xFF0C;&#x4E4B;&#x524D;&#x4E00;&#x76F4;&#x4EE5;&#x4E3A;&#x8D77;&#x5230;&#x7684;&#x662F;&#x9694;&#x79BB;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x4E0D;&#x8FC7;&#x6700;&#x540E;&#x624D;&#x53D1;&#x73B0;&#x4E3A;&#x4E86;ret &#x7ED9;EIP&#x8D4B;&#x6B63;&#x786E;&#x7684;&#x503C;&#x3002;</p>
<p>&#x6700;&#x7EC8;&#x5408;&#x8D77;&#x6765;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code>addl $0x8, %esp

subl $0x4, 0x28(%esp)
movl 0x28(%esp), %edx

movl 0x20(%esp), %eax
movl %eax, (%edx)

popal
addl $0x4, %esp
popfl
popl %esp

ret
</code></pre><p>&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x7684;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF0C;page_fault_handle&#x7684;&#x6808;&#x53D8;&#x5316;&#x60C5;&#x51B5;&#xFF1A;</p>
<p>&#x9677;&#x5165;&#xFF1A;&#x7528;&#x6237;&#x6808;-&gt;&#x5185;&#x6838;&#x6808;-&gt;&#x5F02;&#x5E38;&#x6808;</p>
<p>&#x8FD4;&#x56DE;&#xFF1A;&#x5F02;&#x5E38;&#x6808;-&gt;&#x7528;&#x6237;&#x6808;</p>
<p>&#x5982;&#x679C;&#x662F;&#x5D4C;&#x5957;&#x5904;&#x7406;&#xFF0C;&#x6548;&#x679C;&#x4E5F;&#x662F;&#x7C7B;&#x4F3C;&#x7684;&#xFF0C;&#x8FD4;&#x56DE;&#x4E2D;&#x90FD;&#x4E0D;&#x4F1A;&#x7ECF;&#x8FC7;&#x5185;&#x6838;&#x6808;&#xFF0C;&#x82E5;page fault&#x5D4C;&#x5957;&#xFF0C;&#x90A3;&#x4E48;&#x8FD4;&#x56DE;&#x8FC7;&#x7A0B;&#x4E3A;&#xFF1A;</p>
<p>&#x5F02;&#x5E38;&#x6808;&#x5E27;n-&gt;&#x5F02;&#x5E38;&#x6808;&#x5E27;n-1 ... -&gt;&#x7528;&#x6237;&#x6808;</p>
<p><img src="lab4-Preemptive Multitasking/return.png" alt=""></p>
<h4 id="exercise-11">exercise 11</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>/kern/pgfault.c</code>&#x4E2D;&#x7684;<code>set_pgfault_handler</code>&#x51FD;&#x6570;</p>
</blockquote>
<p><code>set_pgfault_handler</code>&#x53EF;&#x4EE5;&#x5728;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x5728;&#x7528;&#x6237;&#x6001;&#x81EA;&#x7531;&#x5B9A;&#x4E49;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;</p>
<pre><code class="lang-c">//
// Set the page fault handler function.
// If there isn&apos;t one yet, _pgfault_handler will be 0.
// The first time we register a handler, we need to
// allocate an exception stack (one page of memory with its top
// at UXSTACKTOP), and tell the kernel to call the assembly-language
// _pgfault_upcall routine when a page fault occurs.
//
void
set_pgfault_handler(void (*handler)(struct UTrapframe *utf))
{
    int r;

    if (_pgfault_handler == 0) {
        // First time through!
        // LAB 4: Your code here.
         envid_t envid = sys_getenvid();
        if(sys_page_alloc(envid, (void *)(UXSTACKTOP-PGSIZE), PTE_U | PTE_W | PTE_P) &lt; 0)
            panic(&quot;set_pgfault_handler: sys_page_alloc failed. &quot;);
        if(sys_env_set_pgfault_upcall(thisenv-&gt;env_id, _pgfault_upcall) &lt; 0)
            panic(&quot;set_pgfault_handler: sys_env_set_pgfault_upcall failed.&quot;);
        //panic(&quot;set_pgfault_handler not implemented&quot;);
    }

    // Save handler pointer for assembly to call.
    _pgfault_handler = handler;
}
</code></pre>
<h4 id="implementing-copy-on-write-fork">Implementing Copy-on-Write Fork</h4>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5728;&#x7528;&#x6237;&#x6001;&#x5B8C;&#x6210;&#x4E86;copy-on-write&#x5FC5;&#x8981;&#x7684;&#x51FD;&#x6570;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x5728;fork()&#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x4E5F;&#x4F1A;&#x5728;child process&#x590D;&#x5236;parent process&#x6574;&#x4E2A;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;&#x548C;dumbfork()&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;fork()&#x53EA;&#x6709;&#x5F53;&#x67D0;&#x4E2A;&#x8FDB;&#x7A0B;&#x5C1D;&#x8BD5;&#x5BF9;&#x9875;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x9875;&#xFF0C;&#x4F7F;&#x5176;&#x80FD;&#x591F;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x6574;&#x4E2A;fork()&#x6D41;&#x7A0B;&#x57FA;&#x672C;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>parent process&#x901A;&#x8FC7;<code>set_pgfault_handler()</code>&#x5EFA;&#x7ACB;pgfault()&#x3002;</p>
</li>
<li><p>parent process &#x4F7F;&#x7528;sys_exofork()&#x53BB;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;child process&#x3002;</p>
</li>
<li><p>&#x5728;parent process&#x4E2D;<code>UTOP</code>&#x4EE5;&#x4E0B;&#x7684;&#x5185;&#x5B58;&#x90E8;&#x5206;&#xFF0C;&#x82E5;&#x6743;&#x9650;&#x662F;&#x53EF;&#x5199;(writable)&#x6216;&#x8005;&#x662F;copy-on-write&#x6743;&#x9650;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F7F;&#x7528;duppage&#x3002;&#x4FEE;&#x6539;&#x7684;&#x6B65;&#x9AA4;&#x4E3A;&#xFF1A;&#x2460;&#x5C06;&#x8FD9;&#x4E9B;&#x9875;&#x6620;&#x5C04;&#x5230;child process&#x5E76;&#x4E14;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x4E3A;copy-on-write&#x3002;&#x2461;&#x91CD;&#x65B0;&#x5C06;&#x8FD9;&#x4E9B;&#x9875;&#x6743;&#x9650;&#x6539;&#x4E3A;copy-on-write&#xFF08;&#x6CE8;&#x610F;&#x5148;&#x8BBE;&#x7F6E;child process&#x518D;&#x8BBE;&#x7F6E;parent process&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x8BBE;&#x60F3;&#x4E00;&#x4E2A;&#x8C03;&#x6362;&#x987A;&#x5E8F;&#x7684;&#x53CD;&#x4F8B;&#xFF1A;------------&#xFF09;&#x3002;duppage&#x6743;&#x9650;&#x4F7F;&#x7528;PTEs|PTE_COW&#x6765;&#x533A;&#x5206;&#x90A3;&#x4E9B;&#x771F;&#x6B63;&#x53EA;&#x8BFB;&#x7684;&#x9875;&#x3002;</p>
<p>&#x9700;&#x8981;&#x7ED9;child process&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8981;&#x5BF9;&#x4E2D;&#x65AD;&#x4E00;&#x573A;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x80FD;&#x5BF9;&#x5176;&#x4F7F;&#x7528;COW&#x3002;</p>
</li>
<li><p>parent process&#x4E3A;child process&#x8BBE;&#x7F6E;user page fault handler entrypoint&#x3002;</p>
</li>
<li><p>&#x5C06;&#x4E00;&#x5F00;&#x59CB;&#x521B;&#x5EFA;&#x7684;&#x65B0;child process <code>ENV_NOT_RUNNABLE</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>ENV_RUNNABLE</code></p>
</li>
</ol>
<p>&#x6BCF;&#x5F53;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5BF9;&#x8FD9;&#x4E9B;COW&#x9875;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x751F;page fault&#x3002;&#x4E0B;&#x9762;&#x8BB2;&#x8BB2;user page fault handler&#x7684;&#x63A7;&#x5236;&#x6D41;&#xFF1A;</p>
<ol>
<li>&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x9677;&#x5165;&#x5185;&#x6838;&#xFF0C;trap()&#x4F1A;&#x8BBE;&#x7F6E;UTrapframe()&#x5E76;&#x4E14;&#x9677;&#x5165;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x8C03;&#x7528;pgfault() handler&#x3002;</li>
<li>pgfault()&#x4F1A;&#x68C0;&#x6D4B;&#x8FD9;&#x4E9B;&#x9875;&#x662F;&#x5426;&#x53EF;&#x5199;&#xFF0C;&#x6216;&#x8005;&#x65F6;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x4E3A;COW&#x7684;&#x9875;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x4E24;&#x79CD;&#x6743;&#x9650;&#xFF0C;&#x90A3;&#x4E48;&#x62A5;&#x9519;&#x3002;</li>
<li>pgfault()&#x5728;&#x9996;&#x5148;&#x5728;<code>PFTEMP</code>&#x5206;&#x914D;&#x6620;&#x5C04;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x9875;&#x5185;&#x5BB9;&#x590D;&#x5236;&#x5230;&#x8FD9;&#x4E2A;&#x65B0;&#x5206;&#x914D;&#x7684;&#x7269;&#x7406;&#x9875;&#x4E2D;&#xFF0C;&#x91CD;&#x65B0;&#x5BF9;&#x6620;&#x5C04;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x4ECE;&#x800C;&#x5B8C;&#x6210;&#x65B0;&#x9875;&#x9762;&#x7684;&#x8BBE;&#x7F6E;&#x3002;</li>
</ol>
<h4 id="exercise-12">exercise 12</h4>
<blockquote>
<p>&#x5B9E;&#x73B0;<code>/lib/fork.c</code>&#x4E2D;&#x7684;fork&#xFF0C;duppage&#x548C;pgfault&#x51FD;&#x6570;&#x3002;</p>
</blockquote>
<p><code>fork&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;</code>&#xFF1A;&#x9AD8;&#x5C42;&#x7684;COW&#x8C03;&#x7528;</p>
<pre><code class="lang-c"><span class="hljs-keyword">envid_t</span>
fork(<span class="hljs-keyword">void</span>)
{
    <span class="hljs-comment">// LAB 4: Your code here.</span>
    set_pgfault_handler(pgfault);
    <span class="hljs-keyword">envid_t</span> envid = sys_exofork();
    <span class="hljs-keyword">if</span> (envid &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;fork: sys_exofork failed.&quot;</span>);
    <span class="hljs-keyword">if</span> (envid == <span class="hljs-number">0</span>) {
        thisenv = envs + ENVX(sys_getenvid());
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
     <span class="hljs-keyword">uint32_t</span> addr;
    <span class="hljs-keyword">for</span> (addr = <span class="hljs-number">0</span>; addr &lt; USTACKTOP; addr += PGSIZE)
        <span class="hljs-keyword">if</span> ((uvpd[PDX(addr)] &amp; PTE_P) &amp;&amp; (uvpt[PGNUM(addr)] &amp; PTE_P) )
            duppage(envid, PGNUM(addr));

    <span class="hljs-keyword">if</span> (sys_page_alloc(envid, (<span class="hljs-keyword">void</span> *)(UXSTACKTOP - PGSIZE), PTE_U | PTE_W | PTE_P) &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;fork: sys_page_alloc failed.&quot;</span>);

    sys_env_set_pgfault_upcall(envid, _pgfault_upcall);

    <span class="hljs-keyword">if</span> (sys_env_set_status(envid, ENV_RUNNABLE) &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;fork: sys_env_set_status failed.&quot;</span>);

    <span class="hljs-keyword">return</span> envid;
    <span class="hljs-comment">//panic(&quot;fork not implemented&quot;);</span>
}
</code></pre>
<p><code>duppage</code>&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;&#x5B9E;&#x73B0;&#x5185;&#x5B58;&#x5171;&#x4EAB;</p>
<pre><code class="lang-c"><span class="hljs-comment">//</span>
<span class="hljs-comment">// Map our virtual page pn (address pn*PGSIZE) into the target envid</span>
<span class="hljs-comment">// at the same virtual address.  If the page is writable or copy-on-write,</span>
<span class="hljs-comment">// the new mapping must be created copy-on-write, and then our mapping must be</span>
<span class="hljs-comment">// marked copy-on-write as well.  (Exercise: Why do we need to mark ours</span>
<span class="hljs-comment">// copy-on-write again if it was already copy-on-write at the beginning of</span>
<span class="hljs-comment">// this function?)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Returns: 0 on success, &lt; 0 on error.</span>
<span class="hljs-comment">// It is also OK to panic on error.</span>
<span class="hljs-comment">//</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">duppage</span><span class="hljs-params">(envid_t envid, <span class="hljs-keyword">unsigned</span> pn)</span>
</span>{
    <span class="hljs-keyword">int</span> r;

    <span class="hljs-comment">// LAB 4: Your code here.</span>

    <span class="hljs-keyword">void</span> *addr = (<span class="hljs-keyword">void</span> *)(pn * PGSIZE);
    <span class="hljs-keyword">if</span>((uvpt[pn] &amp; PTE_W) || (uvpt[pn] &amp; PTE_COW)){
        <span class="hljs-keyword">if</span>(sys_page_map(<span class="hljs-number">0</span>, addr, envid, addr, PTE_U | PTE_COW | PTE_P) &lt; <span class="hljs-number">0</span>)
            panic(<span class="hljs-string">&quot;duppage: parent-&gt;child sys_page_map failed.&quot;</span>);
        <span class="hljs-keyword">if</span>(sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, PTE_U | PTE_COW | PTE_P) &lt; <span class="hljs-number">0</span>)
            panic(<span class="hljs-string">&quot;duppage: self sys_page_map failed.&quot;</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span>(sys_page_map(<span class="hljs-number">0</span>, addr, envid, addr, PTE_P | PTE_U) &lt; <span class="hljs-number">0</span>)
            panic(<span class="hljs-string">&quot;duppage: single sys_page_map failed.&quot;</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><code>pgfault</code>&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;&#x4E00;&#x65E6;&#x53D1;&#x751F;&#x51B2;&#x7A81;&#xFF0C;&#x5C31;&#x5F00;&#x59CB;&#x7269;&#x7406;&#x9875;&#x7684;&#x590D;&#x5236;&#x5206;&#x79BB;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">pgfault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> UTrapframe *utf)</span>
</span>{
    <span class="hljs-keyword">void</span> *addr = (<span class="hljs-keyword">void</span> *) utf-&gt;utf_fault_va;
    <span class="hljs-comment">//cprintf(&quot;fault va = %x\n&quot;, utf-&gt;utf_fault_va);</span>
    <span class="hljs-keyword">uint32_t</span> err = utf-&gt;utf_err;
    <span class="hljs-keyword">int</span> r;

    <span class="hljs-comment">// Check that the faulting access was (1) a write, and (2) to a</span>
    <span class="hljs-comment">// copy-on-write page.  If not, panic.</span>
    <span class="hljs-comment">// Hint:</span>
    <span class="hljs-comment">//   Use the read-only page table mappings at uvpt</span>
    <span class="hljs-comment">//   (see &lt;inc/memlayout.h&gt;).</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>

    <span class="hljs-comment">// Allocate a new page, map it at a temporary location (PFTEMP),</span>
    <span class="hljs-comment">// copy the data from the old page to the new page, then move the new</span>
    <span class="hljs-comment">// page to the old page&apos;s address.</span>
    <span class="hljs-comment">// Hint:</span>
    <span class="hljs-comment">//   You should make three system calls.</span>

    <span class="hljs-comment">// LAB 4: Your code here.</span>


    <span class="hljs-keyword">if</span>(!(err &amp; FEC_WR) || !(uvpt[PGNUM(addr)] &amp; PTE_COW))
        panic(<span class="hljs-string">&quot;pgfault: invalid UTrapFrame&quot;</span>);

    <span class="hljs-keyword">envid_t</span> envid = sys_getenvid();
    addr = ROUNDDOWN(addr, PGSIZE);
    <span class="hljs-comment">// if(envid == 4097){</span>
    <span class="hljs-comment">//     //cprintf(&quot;%x\n&quot;, addr);</span>
    <span class="hljs-comment">//     int val = sys_page_map(4097, addr, 4097, addr, PTE_U | PTE_W | PTE_P);</span>
    <span class="hljs-comment">//     cprintf(&quot;return erro %d\n&quot;, val);</span>
    <span class="hljs-comment">//     return ;</span>
    <span class="hljs-comment">// }</span>
    <span class="hljs-comment">//cprintf(&quot;now allocating page: envid %d \n&quot;, envid);</span>
    <span class="hljs-keyword">if</span>(sys_page_alloc(envid, PFTEMP, PTE_U | PTE_W | PTE_P) &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;pgfault: sys_page_alloc failed.&quot;</span>);
    <span class="hljs-built_in">memcpy</span>(PFTEMP, addr, PGSIZE);
    <span class="hljs-keyword">if</span>(sys_page_map(envid, PFTEMP, envid, addr, PTE_U | PTE_W | PTE_P) &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;pgfault: sys_page_map failed.&quot;</span>);
    <span class="hljs-keyword">if</span>(sys_page_unmap(envid, PFTEMP) &lt; <span class="hljs-number">0</span>)
        panic(<span class="hljs-string">&quot;pgfault: sys_page_unmap failed.&quot;</span>);
    <span class="hljs-comment">//panic(&quot;pgfault not implemented&quot;);</span>
}
</code></pre>
<p><code>_pgfault_upcall</code>&#x662F;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x7684;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F7F;&#x5F97;&#x7A0B;&#x5E8F;&#x80FD;&#x591F;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x9677;&#x5165;&#x5230;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#x90E8;&#x5206;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">//&#x9677;&#x5165;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x8C03;&#x7528;</span>
tf-&gt;tf_eip = (<span class="hljs-keyword">uint32_t</span>)curenv-&gt;env_pgfault_upcall;
</code></pre>
<p>&#x800C;<code>_pgfault_handler</code>&#x90E8;&#x5206;&#x662F;&#x7528;&#x6237;&#x80FD;&#x591F;&#x81EA;&#x7531;&#x5B9A;&#x4E49;&#x7684;page fault&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x5DF2;&#x7ECF;&#x9677;&#x5165;&#x5230;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6808;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x3002;</p>
<pre><code class="lang-c">_pgfault_upcall:
    <span class="hljs-comment">// Call the C page fault handler.</span>
    pushl %esp            <span class="hljs-comment">// function argument: pointer to UTF</span>
    movl _pgfault_handler, %eax 
    call *%eax                <span class="hljs-comment">//&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x8C03;&#x7528;</span>
    addl $<span class="hljs-number">4</span>, %esp            <span class="hljs-comment">// pop function argument</span>
</code></pre>
<blockquote>
<p>&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x8FD9;&#x6837;&#x4E0D;&#x4F1A;&#x9020;&#x6210;&#x9875;&#x9762;&#x7684;&#x6D6A;&#x8D39;&#x5417;&#xFF1F;&#x56E0;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;&#x8BE5;&#x9875;&#x8BBE;&#x7F6E;&#x4E3A;&#x53EA;&#x8BFB;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x5C1D;&#x8BD5;&#x4FEE;&#x6539;&#x540E;&#xFF0C;&#x90FD;&#x4F1A;&#x590D;&#x5236;&#x65B0;&#x9875;&#x3002;&#x5E76;&#x6CA1;&#x6709;&#x533A;&#x5206;child process&#x8FD8;&#x662F;parent process&#x3002;(&#x9700;&#x8981;&#x8FDB;&#x884C;&#x5B9E;&#x9524;)</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x9A8C;&#x8BC1;&#x4E0A;&#x9762;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x6784;&#x9020;&#x51FD;&#x6570;<code>/user/forktwice.c</code>&#xFF0C;&#x5E76;&#x4E14;&#x5728;pgfault()&#x51FD;&#x6570;&#x548C;sys_page_map()(&#x786C;&#x7F16;&#x7801;&#x4EE3;&#x7801;&#x5F88;&#x4E11;)&#x4E2D;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x7531;&#x4E8E;&#x8BE5;&#x7A0B;&#x5E8F;&#x662F;parent&#x5148;&#x53D1;&#x751F;&#x9875;&#x9519;&#x8BEF;&#x4E2D;&#x65AD;&#xFF0C;&#x7136;&#x540E;child process&#x653E;&#x751F;&#x9875;&#x9519;&#x8BEF;&#x4E2D;&#x65AD;&#x3002;&#x6211;&#x4EEC;&#x5728;&#x7B2C;&#x4E8C;&#x6B21;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x540E;&#x76F4;&#x63A5;&#x5C06;&#x8BE5;&#x9875;&#x9762;&#x6539;&#x4E3A;&#x53EF;&#x5199;&#x3002;&#x53D1;&#x73B0;&#x7A0B;&#x5E8F;&#x662F;&#x80FD;&#x6B63;&#x786E;&#x7684;&#x8FD0;&#x884C;&#x7684;&#xFF0C;&#x53D1;&#x73B0;&#x786E;&#x5B9E;&#x6709;&#x591A;&#x4F59;&#x7684;&#x9875;&#x5206;&#x914D;&#x3002;</p>
<p>&#x6700;&#x540E;&#x60F3;&#x60F3;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x6837;&#x63D0;&#x5347;&#x6548;&#x7387;&#x5E76;&#x4E0D;&#x5BF9;&#x3002;&#x8BBE;&#x60F3;&#x5728;parent process&#x4E2D;&#x8FDB;&#x884C;10&#x6B21;fork()&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x8C01;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x83B7;&#x5F97;&#x8BE5;&#x9875;&#x9762;&#x7684;&#x6743;&#x9650;&#xFF0C;&#x56E0;&#x6B64;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x95F4;&#x6362;&#x65F6;&#x95F4;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<h3 id="part-c-preemptive-multitasking-and-inter-process-communication-ipc">Part C: Preemptive Multitasking and Inter-Process communication (IPC)</h3>
<h4 id="clock-interrupts-and-preemption">Clock Interrupts and Preemption</h4>
<p>&#x76EE;&#x524D;JOS&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x7A0B;&#x4E3B;&#x52A8;&#x4EA4;&#x51FA;&#x8FD0;&#x884C;&#x7684;&#x6743;&#x9650;&#xFF0C;&#x624D;&#x80FD;&#x5207;&#x6362;&#x8FDB;&#x7A0B;&#x3002;&#x5982;&#x679C;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x4F7F;&#x7528;while&#x6B7B;&#x5FAA;&#x73AF;&#xFF0C;&#x90A3;&#x4E48;&#x5176;&#x4ED6;&#x7684;&#x8FDB;&#x7A0B;&#x548C;&#x5185;&#x6838;&#x5C06;&#x6C38;&#x8FD0;&#x90FD;&#x4E0D;&#x80FD;&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x5C06;&#x662F;&#x81F4;&#x547D;&#x7684;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x8BA9;kernel&#x4E3B;&#x52A8;&#x7684;&#x593A;&#x56DE;&#x4F7F;&#x7528;&#x6743;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4F7F;&#x5F97;JOS&#x652F;&#x6301;&#x5916;&#x90E8;&#x786C;&#x4EF6;&#x7684;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#x3002;</p>
<h4 id="interrupt-discipline">Interrupt discipline</h4>
<p>&#x5916;&#x754C;&#x4E2D;&#x65AD;&#xFF08;IRQs&#xFF09;&#x6709;16&#x4E2A;&#xFF0C;&#x5728;IDT&#x8868;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;&#x4E3A;<code>IRQ_OFFSET</code> &#x5230; <code>IRQ_OFFSET+15</code>.</p>
<p>&#x5728;JOS&#x7684;&#x8BBE;&#x7F6E;&#x4E2D;<code>IRQ_OFFSET=32</code>&#x3002;&#x8FD9;&#x6837;&#x8BBE;&#x7F6E;&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x4E0D;&#x8BA9;&#x548C;processor exceptions&#x91CD;&#x53E0;&#x3002;</p>
<p>&#x5728;JOS&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x505A;&#x4E86;&#x7B80;&#x5316;&#xFF1A;&#x5728;&#x7528;&#x6237;&#x6001;&#x53EF;&#x4EE5;&#x6FC0;&#x53D1;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x5185;&#x6838;&#x6001;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5173;&#x95ED;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x3002;</p>
<p>&#x5916;&#x754C;&#x4E2D;&#x65AD;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;<code>eflags</code>&#x548C;<code>FL_IF</code>&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x5728;env_alloc&#x521D;&#x59CB;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x786E;&#x5B9E;&#x65B0;&#x589E;&#x4E86;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4F7F;&#x5F97;&#x80FD;&#x591F;&#x5728;&#x7528;&#x6237;&#x6001;&#x4EA7;&#x751F;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// Enable interrupts while in user mode.</span>
<span class="hljs-comment">// LAB 4: Your code here.</span>
e-&gt;env_tf.tf_eflags |= FL_IF;
</code></pre>
<h4 id="exercise-13">exercise 13</h4>
<blockquote>
<p>&#x4FEE;&#x6539;<code>kern/trapentry.S</code>&#x548C;<code>kern/trap.c</code>&#xFF0C;&#x589E;&#x52A0;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x7684;&#x5165;&#x53E3;&#x3002;</p>
<p>&#x5728;<code>sched_halt</code>&#x589E;&#x52A0;sti&#xFF0C;&#x53D6;&#x6D88;&#x5728;&#x5185;&#x6838;&#x6001;&#x7684;&#x4E2D;&#x65AD;&#x3002;</p>
</blockquote>
<pre><code>TRAPHANDLER_NOEC(handler_timer,    IRQ_OFFSET + IRQ_TIMER)
TRAPHANDLER_NOEC(handler_kbd,      IRQ_OFFSET + IRQ_KBD)
TRAPHANDLER_NOEC(handler_serial,   IRQ_OFFSET + IRQ_SERIAL)
TRAPHANDLER_NOEC(handler_spurious, IRQ_OFFSET + IRQ_SPURIOUS)
TRAPHANDLER_NOEC(handler_ide,      IRQ_OFFSET + IRQ_IDE)
TRAPHANDLER_NOEC(handler_error,    IRQ_OFFSET + IRQ_ERROR)
</code></pre><pre><code>SETGATE(idt[IRQ_OFFSET + IRQ_TIMER],    0, GD_KT, handler_timer,    0);
SETGATE(idt[IRQ_OFFSET + IRQ_KBD],      0, GD_KT, handler_kbd,      0);
SETGATE(idt[IRQ_OFFSET + IRQ_SERIAL],   0, GD_KT, handler_serial,   0);
SETGATE(idt[IRQ_OFFSET + IRQ_SPURIOUS], 0, GD_KT, handler_spurious, 0);
SETGATE(idt[IRQ_OFFSET + IRQ_IDE],      0, GD_KT, handler_ide,      0);
SETGATE(idt[IRQ_OFFSET + IRQ_ERROR],    0, GD_KT, handler_error,    0);
</code></pre><p>&#x6700;&#x540E;&#xFF0C;&#x5728;kern/env.c &#x7684;env_alloc() &#x4E2D;&#x52A0;&#x5165;e-&gt;env_tf.tf_eflags |= FL_IF; &#x5728;&#x7528;&#x6237;&#x6001;&#x80FD;&#x8FDB;&#x884C;&#x7528;&#x6237;&#x4E2D;&#x65AD;&#xFF0C;&#x4EE5;&#x4F7F;&#x5F97;&#x4E2D;&#x65AD;&#x53D1;&#x751F;&#x65F6;&#x5185;&#x6838;&#x80FD;&#x591F;&#x6B63;&#x786E;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x53D6;&#x6D88;kern/sched.c &#x4E2D;sti &#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
<h4 id="handling-clock-interrupts">Handling Clock Interrupts</h4>
<p>&#x76EE;&#x524D;<code>lapic_init</code>&#x548C;<code>pic_init</code>&#x521D;&#x59CB;&#x5316;&#x4E86;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x7684;&#x6761;&#x4EF6;&#xFF0C;&#x4F7F;&#x5F97;&#x786C;&#x4EF6;&#x80FD;&#x591F;&#x4EA7;&#x751F;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x5E76;&#x4E14;&#x80FD;&#x591F;&#x88AB;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;&#x5230;&#x3002;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x4E2D;&#x65AD;&#x3002;</p>
<h4 id="exercise-14">exercise 14</h4>
<blockquote>
<p>&#x4FEE;&#x6539;&#x5185;&#x6838;&#x7684;trap_dispatch &#x51FD;&#x6570;&#xFF0C;&#x8BA9;&#x5B83;&#x8C03;&#x7528;sched_yield() &#x6765;&#x5728;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#x53D1;&#x751F;&#x65F6;&#x67E5;&#x627E;&#x5E76;&#x8FD0;&#x884C;&#x4E00;&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x73AF;&#x5883;&#x3002;</p>
</blockquote>
<p>&#x8981;&#x5904;&#x7406;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5728;trap_dispatch &#x4E2D;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x5373;&#x53EF;&#x3002;&#x6CE8;&#x610F;&#x9700;&#x8981;&#x4F7F;&#x7528;lapic_eoi() &#x6765;&#x63A5;&#x53D7;&#x4E2D;&#x65AD;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">// Handle clock interrupts. Don&apos;t forget to acknowledge the</span>
    <span class="hljs-comment">// interrupt using lapic_eoi() before calling the scheduler!</span>
    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">if</span> (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_TIMER) {
        lapic_eoi();
        sched_yield();
    }
</code></pre>
<h4 id="inter-process-communication-ipc">Inter-Process communication (IPC)</h4>
<p>&#x4E4B;&#x524D;&#x6240;&#x6709;&#x505A;&#x7684;&#x5DE5;&#x4F5C;&#xFF0C;&#x4F7F;&#x5F97;&#x8FDB;&#x7A0B;&#x50CF;&#x662F;&#x5355;&#x72EC;&#x4F7F;&#x7528;&#x673A;&#x5668;&#x8D44;&#x6E90;&#x7684;&#x5047;&#x8C61;&#x3002;</p>
<p>&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5C31;&#x662F;&#x7A0B;&#x5E8F;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F3A;&#x6709;&#x529B;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x6BD4;&#x5982;Unix pipe&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x5178;&#x578B;&#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<h4 id="ipc-in-jos">IPC in JOS</h4>
<p>&#x80FD;&#x591F;&#x4F20;&#x9012;&#x4E00;&#x4E2A;32&#x4F4D;&#x7684;&#x6570;&#x5B57;&#x548C;&#x4E00;&#x9875;&#x7684;&#x6620;&#x5C04;&#x3002;&#x4F7F;&#x5F97;&#x901A;&#x4FE1;&#x7684;&#x8FDB;&#x7A0B;&#x5171;&#x4EAB;&#x4E00;&#x4E9B;&#x9875;&#x5185;&#x5BB9;&#x3002;</p>
<h4 id="sending-and-receiving-messages">Sending and Receiving Messages</h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x6536;&#x5230;&#x4FE1;&#x606F;&#xFF0C;&#x63A5;&#x53D7;environment&#x4F1A;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x72B6;&#x6001;&#x8BBE;&#x7F6E;&#x4E3A;<code>ENV_NOT_RUNNALBEL</code>&#x5E76;&#x4E14;&#x4E3B;&#x52A8;&#x4F7F;&#x7528;<code>sys_yield()</code>&#x4E3B;&#x52A8;&#x4EA4;&#x51FA;CPU&#x4F7F;&#x7528;&#x6743;&#x9650;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4E3B;&#x52A8;&#x7684;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x503C;&#xFF0C;&#x8FDB;&#x7A0B;&#x4F1A;&#x4F7F;&#x7528;<code>sys_ipc_try_send</code>&#x53BB;&#x53D1;&#x9001;&#xFF0C;&#x5305;&#x542B;&#x7684;&#x53C2;&#x6570;&#x662F;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x53F7;&#x3002;&#x901A;&#x8FC7;&#x5224;&#x65AD;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x72B6;&#x6001;&#xFF0C;&#x770B;&#x770B;&#x662F;&#x5426;&#x5904;&#x4E8E;&#x63A5;&#x53D7;&#x4FE1;&#x606F;&#x7684;&#x72B6;&#x6001;&#xFF1A;<code>env-&gt;env_ipc_recving</code>&#x3002;</p>
<p>&#x82E5;&#x5BF9;&#x65B9;&#x6210;&#x529F;&#x63A5;&#x6536;&#x4E86;&#x6216;&#x8005;&#x5BF9;&#x65B9;&#x538B;&#x6839;&#x6CA1;&#x6709;&#x63A5;&#x53D7;&#xFF0C;&#x90A3;&#x4E48;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x5426;&#x5219;&#x5176;&#x4ED6;&#x60C5;&#x51B5;&#x53D1;&#x9001;&#x8FDB;&#x7A0B;&#x5904;&#x4E8E;&#x5FD9;&#x8F6E;&#x8BE2;&#x72B6;&#x6001;(while(1))&#x3002;</p>
<p><code>sys_ipc_recv</code>&#x88AB;<code>ipc_recv</code>&#x8C03;&#x7528;&#xFF0C;<code>ipc_recv</code>&#x4F9B;&#x7528;&#x6237;&#x7684;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540C;&#x7406;<code>sys_ipc_send</code>&#x88AB;<code>ipc_recv</code>&#x8C03;&#x7528;&#x3002;</p>
<h4 id="transferring-pages">Transferring Pages</h4>
<p>sys_ipc_try_send&#x4F20;&#x9012;&#x4E00;&#x4E2A;&#x5408;&#x7406;&#x7684;&#x9700;&#x8981;&#x4F20;&#x8F93;&#x7684;&#x9875;&#x865A;&#x62DF;&#x6E90;&#x5730;&#x5740;&#xFF0C;&#x5185;&#x6838;&#x9996;&#x5148;&#x627E;&#x5230;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x63A5;&#x53D7;environment&#x76EE;&#x6807;&#x63A5;&#x53D7;&#x7684;&#x533A;&#x57DF;(dstva&#x9ED8;&#x8BA4;&#x521D;&#x59CB;&#x5316;&#x4E3A;UTOP&#xFF0C;&#x6216;&#x8005;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x6307;&#x5B9A;)&#x8FDB;&#x884C;&#x6620;&#x5C04;&#x3002;</p>
<p>&#x4ECE;&#x800C;&#x8FBE;&#x5230;&#x5171;&#x4EAB;&#x9875;&#x7684;&#x76EE;&#x7684;&#x3002;</p>
<h4 id="implementing-ipc">Implementing IPC</h4>
<h5 id="exercise-15">exercise 15</h5>
<blockquote>
<p>&#x5B9E;&#x73B0;&#x5728;<code>kern/syscall.c</code>&#x4E2D;&#x7684;<code>sys_ipc_recv</code>&#x548C;<code>sys_ipc_try_send</code>&#x3002;&#x6CE8;&#x610F;&#x5C06;&#x8C03;&#x7528;envid2env &#x4E2D;&#x7684;checkperm flag&#x8BBE;&#x7F6E;&#x4E3A;0&#xFF0C;&#x4F7F;&#x5F97;&#x4EFB;&#x4F55;environment&#x90FD;&#x80FD;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;</p>
<p>&#x4E4B;&#x540E;&#x5B9E;&#x73B0;&#x5728;<code>lib/ipc.c</code>&#x4E2D;&#x7684;<code>ipc_recv</code>&#x548C;<code>ipc_send</code>&#x3002;</p>
</blockquote>
<p>&#x9996;&#x5148;&#x5B9E;&#x73B0;sys_ipc_recv&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x53C2;&#x6570;&#x6307;&#x793A;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#x5927;&#x4E8E;UTOP &#x65F6;&#x4E0D;&#x80FD;&#x62A5;&#x9519;&#x9000;&#x51FA;&#xFF0C;&#x800C;&#x9700;&#x8981;&#x5FFD;&#x7565;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x53EA;&#x8BF4;&#x660E;&#x63A5;&#x53D7;&#x8005;&#x53EA;&#x9700;&#x8981;&#x63A5;&#x6536;&#x503C;&#x800C;&#x4E0D;&#x9700;&#x8981;&#x5171;&#x4EAB;&#x9875;&#x9762;&#x3002;&#x5B9E;&#x73B0;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c">static int
sys_ipc_recv(void *dstva)
{
    // LAB 4: Your code here.
    if((uint32_t)dstva &lt; UTOP &amp;&amp; PGOFF(dstva))
        return -E_INVAL;
    curenv-&gt;env_ipc_recving = true;
    curenv-&gt;env_ipc_dstva = dstva;
    curenv-&gt;env_status = ENV_NOT_RUNNABLE;
    sys_yield();
    return 0;
    //panic(&quot;sys_ipc_recv not implemented&quot;);
}
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5B9E;&#x73B0;sys_ipc_try_send&#xFF0C;&#x9700;&#x6C42;&#x4E0E;sys_page_map &#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8C03;&#x7528;sys_page_map&#xFF0C;&#x56E0;&#x4E3A;sys_page_map &#x4F1A;&#x68C0;&#x67E5;env &#x7684;&#x6743;&#x9650;&#x3002;&#x5B9E;&#x73B0;&#x7684;sys_ipc_try_send &#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sys_ipc_try_send</span><span class="hljs-params">(envid_t envid, uint32_t value, <span class="hljs-keyword">void</span> *srcva, <span class="hljs-keyword">unsigned</span> perm)</span>
</span>{
    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">struct</span> Env *env;
    <span class="hljs-keyword">if</span>(envid2env(envid, &amp;env, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -E_BAD_ENV;
    <span class="hljs-keyword">if</span>(!env-&gt;env_ipc_recving)
        <span class="hljs-keyword">return</span> -E_IPC_NOT_RECV;

    <span class="hljs-keyword">pte_t</span> *pte;
    <span class="hljs-keyword">int</span> res;
    <span class="hljs-keyword">struct</span> PageInfo *page = page_lookup(curenv-&gt;env_pgdir, srcva, &amp;pte);
    <span class="hljs-keyword">if</span>((<span class="hljs-keyword">uint32_t</span>)srcva &lt; UTOP &amp;&amp; (
                PGOFF(srcva) || !page ||
                (perm &amp; PTE_W) != (*pte &amp; PTE_W) ||
                !(perm &amp; PTE_U) || !(perm &amp; PTE_P) ||
                (perm &amp; (~PTE_SYSCALL))) )
            <span class="hljs-keyword">return</span> -E_INVAL;
    <span class="hljs-keyword">if</span>((<span class="hljs-keyword">uint32_t</span>)srcva &lt; UTOP &amp;&amp; (res = page_insert(env-&gt;env_pgdir, page, env-&gt;env_ipc_dstva, perm)) &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> res;

    env-&gt;env_ipc_recving = <span class="hljs-number">0</span>;
    env-&gt;env_ipc_from = curenv-&gt;env_id;
    env-&gt;env_ipc_perm = perm;
    env-&gt;env_ipc_value = value;
    env-&gt;env_status = ENV_RUNNABLE;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//panic(&quot;sys_ipc_try_send not implemented&quot;);</span>
}
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5B9E;&#x73B0;&#x5BF9;&#x4E8E;&#x4E0A;&#x9762;&#x4E24;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5C01;&#x88C5;&#x3002;&#x9996;&#x5148;&#x662F;ipc_recv&#xFF0C;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x5F53;&#x4E0D;&#x9700;&#x8981;&#x5171;&#x4EAB;&#x9875;&#x9762;&#x65F6;&#x5C06;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8BBE;&#x7F6E;&#x4E3A;&#x5927;&#x4E8E;&#x6216;&#x7B49;&#x4E8E;UTOP &#x7684;&#x503C;&#x3002;ipc_recv &#x5B9E;&#x73B0;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">int32_t</span>
ipc_recv(<span class="hljs-keyword">envid_t</span> *from_env_store, <span class="hljs-keyword">void</span> *pg, <span class="hljs-keyword">int</span> *perm_store)
{
    <span class="hljs-comment">// LAB 4: Your code here.</span>
    <span class="hljs-keyword">if</span>(!pg)
        pg = (<span class="hljs-keyword">void</span> *)UTOP;
    <span class="hljs-keyword">int</span> res;
    <span class="hljs-keyword">if</span>((res = sys_ipc_recv(pg)) &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">if</span>(from_env_store)
            *from_env_store = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span>(perm_store)
            *perm_store = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> res;
    }
    <span class="hljs-keyword">if</span>(from_env_store)
        *from_env_store = thisenv-&gt;env_ipc_from;
    <span class="hljs-keyword">if</span>(perm_store)
        *perm_store = thisenv-&gt;env_ipc_perm;
    <span class="hljs-keyword">return</span> thisenv-&gt;env_ipc_value;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//panic(&quot;ipc_recv not implemented&quot;);</span>
}
</code></pre>
<p>&#x7136;&#x540E;&#x662F;ipc_send&#xFF0C;&#x540C;&#x6837;&#xFF0C;&#x5F53;pg &#x4E3A;NULL &#x65F6;&#x8BBE;&#x7F6E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x4E3A;&#x5927;&#x4E8E;&#x6216;&#x7B49;&#x4E8E;UTOP &#x7684;&#x503C;&#x3002;ipc_send&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">ipc_send</span><span class="hljs-params">(envid_t to_env, uint32_t val, <span class="hljs-keyword">void</span> *pg, <span class="hljs-keyword">int</span> perm)</span>
</span>{
    <span class="hljs-comment">// LAB 4: Your code here.</span>
     <span class="hljs-keyword">if</span>(!pg)
        pg = (<span class="hljs-keyword">void</span> *)UTOP;
    <span class="hljs-keyword">int</span> res;
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
        res = sys_ipc_try_send(to_env, val, pg, perm);
        <span class="hljs-keyword">if</span>(!res)
            <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span>(res != -E_IPC_NOT_RECV)
            panic(<span class="hljs-string">&quot;ipc_send: not receiving&quot;</span>);
        sys_yield();
    }
    <span class="hljs-comment">//panic(&quot;ipc_send not implemented&quot;);</span>
}
</code></pre>
<p>&#x6700;&#x540E;&#x52A0;&#x5165;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF1A;</p>
<pre><code class="lang-c">        <span class="hljs-keyword">case</span> SYS_ipc_try_send:
            <span class="hljs-keyword">return</span> sys_ipc_try_send(a1, a2, (<span class="hljs-keyword">void</span> *)a3, a4);
        <span class="hljs-keyword">case</span> SYS_ipc_recv:
            <span class="hljs-keyword">return</span> sys_ipc_recv((<span class="hljs-keyword">void</span> *)a1);
</code></pre>
<p><img src="lab4-Preemptive Multitasking/result.png" alt=""></p>
<h4 id="&#x756A;&#x5916;&#xFF1A;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x662F;&#x600E;&#x4E48;&#x8FDB;&#x884C;&#x7684;">&#x756A;&#x5916;&#xFF1A;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x662F;&#x600E;&#x4E48;&#x8FDB;&#x884C;&#x7684;</h4>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;<code>init_i386</code>&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x8C03;&#x7528;:</p>
<pre><code class="lang-c">pic_init();
</code></pre>
<p>&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B9E;&#x9A8C;&#x7684;&#x7BC7;&#x5E45;&#x5F88;&#x5C11;&#x6D89;&#x53CA;&#x5230;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4E3B;&#x8981;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x5BF9;&#x53EF;&#x7F16;&#x7A0B;&#x4E2D;&#x65AD;&#x786C;&#x4EF6;8259&#x8FDB;&#x884C;&#x7684;&#x521D;&#x59CB;&#x5316;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x9762;&#x8FD8;&#x662F;&#x5927;&#x6709;&#x5B66;&#x95EE;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x8FD9;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#xFF0C;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x81EA;&#x5DF1;&#x5927;&#x5B66;&#x672C;&#x79D1;&#x5B66;&#x4E60;&#x7684;&#x300A;&#x5FAE;&#x673A;&#x539F;&#x7406;&#x300B;&#x91CC;&#x9762;&#x7684;&#x8D44;&#x6599;&#xFF0C;&#x4E00;&#x5B9A;&#x4F1A;&#x6709;&#x65B0;&#x7684;&#x53D1;&#x73B0;&#x548C;&#x8BA4;&#x8BC6;&#x3002;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5177;&#x4F53;&#x8FDB;&#x884C;&#x7EC6;&#x81F4;&#x7684;&#x7A0B;&#x5E8F;&#x5206;&#x6790;&#x4E86;&#x3002;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Lab3-User Environments.html" class="navigation navigation-prev " aria-label="Previous page: Lab3: User Environments">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="lab5-File system, Spawn and Shell.html" class="navigation navigation-next " aria-label="Next page: lab5: File system, Spawn and Shell">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"lab4: Preemptive Multitasking","level":"1.6","depth":1,"next":{"title":"lab5: File system, Spawn and Shell","level":"1.7","depth":1,"path":"lab5-File system, Spawn and Shell.md","ref":"./lab5-File system, Spawn and Shell.md","articles":[]},"previous":{"title":"Lab3: User Environments","level":"1.5","depth":1,"path":"Lab3-User Environments.md","ref":"./Lab3-User Environments.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["callouts@git+https://github.com/Simran-B/gitbook-plugin-callouts.git","intopic-toc","theme-comscore","-lunr","-search","search-pro","github","splitter","-sharing","mathjax-pro"],"pluginsConfig":{"callouts":{"showTypeInHeader":true},"github":{"url":"https://github.com/KnowledgeHive/ddia"},"intopic-toc":{"isCollapsed":false,"isScrollspyActive":true,"label":{"de":"导航","en":"导航","ch":"导航"},"maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"splitter":{},"search-pro":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"theme-comscore":{},"mathjax-pro":{"forceSVG":false,"version":"2.7.7"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lab4-Preemptive Multitasking.md","mtime":"2021-02-19T16:32:52.019Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-02-19T16:39:19.156Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mathjax-pro/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

